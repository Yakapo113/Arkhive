<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Real Estate Investment Simulator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg-0: #f5f7fb;
      --bg-1: #ffffff;
      --muted: #52606a;
      --accent: #2563eb;
      --card-shadow: 0 6px 22px rgba(38,56,100,0.06);
      --radius: 12px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-0),#eef3fb 100%);color:#0b1220}
    .container{max-width:1200px;margin:28px auto;padding:20px}
    header{display:flex;gap:14px;align-items:center;margin-bottom:18px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(180deg,#e6f0ff,#cfe3ff);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--accent)}
    h1{font-size:20px;margin:0}
    .subtitle{color:var(--muted);font-size:13px}
    .layout{display:grid;grid-template-columns:440px 1fr;gap:18px}
    .card{background:var(--bg-1);border-radius:var(--radius);margin-bottom: 12px;padding:14px;box-shadow:var(--card-shadow);border:1px solid rgba(9, 30, 66, 0.25)}
    .card2{background-color: #05d82c00;border-radius:var(--radius);border:1px solid rgba(9,30,66,0.14); display: grid;margin-bottom: 12px;padding: 12px; grid-template-rows: 2fr 2fr;grid-template-columns:1fr 1fr 1fr; gap:10px}
    .form-row{display:flex;align-items:flex-start;margin-bottom:10px}
    .form-row label{font-size:10pt;width:220px;font-weight:450;margin-top:4px}
    .input-pair{display:flex;gap:16px;align-items:flex-start}
    .input-column{display:flex;flex-direction:column}
    /* --- Remove spinners from number inputs --- */
    input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}input[type=number]{-moz-appearance:textfield}
    input[type="number"],input[type="text"],select{padding:8px;border-radius:8px;border:1px solid rgba(9,30,66,0.06);background:transparent;color:inherit;font-size:13px;width:80px}
    .small{font-size:12px;color:var(--muted)}
    .btn{background:var(--accent);border:none;padding:9px 12px;border-radius:10px;color:white;cursor:pointer;font-weight:700}
    .results{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;margin-top:8px;}
    .results.hold-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    .tile{background:linear-gradient(180deg,rgba(8,16,44,0.02),transparent);padding:12px;border-radius:10px;border:1px solid rgba(0, 0, 0, 0.336)}
    .tile h3{margin:0;font-size:13px;color:var(--muted)}
    .tile p{margin:6px 0 0;font-size:18px;font-weight:700}
    .section-title{font-size:14px;margin:8px 0;color:var(--muted);display:flex;align-items:center;justify-content:space-between}
    .list{background:rgba(38,56,100,0.03);padding:8px;border-radius:10px}
    .unit-item{display:flex;gap:8px;align-items:center;flex-wrap:nowrap}
    .unit-item input{width:80px;flex-grow:0;flex-shrink:0;max-width:80px;box-sizing:border-box}
    .add-btn{background-color:#2563eb;color:white;border-radius:8px;border:1px solid #051749;padding:6px 8px}
    .remove-btn{background-color:#3d0202;color:white;border-radius:8px;border:1px solid #3d0202;padding:6px 8px}
    .scenario-row{display:flex;gap:8px;margin-top:8px}
    .scenario-row button{padding:6px 8px;border-radius:8px;border:1px solid rgba(9,30,66,0.08);background:#f5f7fb;cursor:pointer}
    .downpayment-toggle{display:flex;gap:6px;margin-left:-180px;}
    .downpayment-toggle button{padding: 6px 8px;border-radius: 8px;border: 1px solid rgba(9,30,66,0.08);background: #f5f7fb;cursor: pointer;font-size: 12px;font-weight: 600;color: #0b1220;transition: all 0.15s ease-in-out;}
    .layout button.active{background:var(--accent);color:white;border-color: var(--accent)}
    .scenario-row button.active{background:var(--accent);color:white;border-color:var(--accent)}
    @media (max-width:1000px){.layout{grid-template-columns:1fr}.charts-row{flex-direction:column}}
    /* extra small helpers */
    .muted{color:var(--muted);font-size:13px}
    .help-icon{display:inline-block;margin-left:4px;font-size:14px;color:var(--accent)}
    .chart-wrap{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start}
    label[data-tooltip], .tile[data-tooltip] { cursor: help; }
    .tile[data-tooltip], label[data-tooltip] {cursor: help;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">RE</div>
      <div>
        <h1>Real Estate Investment Simulator</h1>
        <div class="subtitle">Advanced calculator simulating investment growth accounting for taxes and other liabilities</div>
      </div>
    </header>

    <div class="layout">
      <!-- LEFT: Inputs -->
      <div class="card" id="inputsCard">
        <div class="section-title"><strong>Property & Financing</strong></div>

        <div class="form-row"><label>Purchase Price ($)</label><input id="purchasePrice" type="number" value="300000" placeholder="$" /></div>
        <div class="form-row"><label>Appraised Value ($)</label><input id="appraisedValue" type="number" placeholder="$" /></div>

        <div class="form-row">
          <label>Down Payment</label>
          <div style="display:flex;flex-direction:column">
            <div class="input-pair">
              <div class="input-column"><div class="small muted">Amount ($)</div><input id="downPaymentValue" type="number" placeholder="$"></div>
              <div class="input-column"><div class="small muted">Percent (%)</div><input id="downPaymentPercent" type="number" value="20" placeholder="%"></div>
            </div>
            <div class="downpayment-toggle">
              <button id="amountButton">Amount</button>
              <button id="percentButton" class="active">Percent</button>
            </div>
          </div>
        </div>

        <div class="form-row"><label>Loan Interest (%)</label><input id="interestRate" type="number" value="6.5" placeholder="%" /></div>
        <div class="form-row"><label>Loan Term (yrs)</label><input id="loanTerm" type="number" value="30" placeholder="yrs" /></div>
        <div class="form-row"><label data-tooltip="Typically 2% of Purchase Price">Total Closing Costs ($)</label><input id="closingCosts" type="number" value="6000" placeholder="$" /></div>
        <div class="form-row"><label>Closing Costs paid by Seller ($)</label><input id="sellerpaidclosingCosts" type="number" value="1500" placeholder="$" /></div>
        <div class="form-row"><label data-tooltip="Will vary on county try 5% as starter">Land Value ($)<span class="help-icon" data-tooltip="Used for depreciation calculations.">ℹ️</span></label><input id="landValue" type="number" value="15000" placeholder="$" /></div>

        <hr style="opacity:0.08;margin:12px 0" />

        <div class="section-title"><strong>Rental Unit Income</strong></div>
        <div class="form-row"><label># of Units</label><input id="numUnits" type="number" value="1" min="1" /></div>

        <div class="small muted" style="margin-bottom:8px">Set rent per unit — add/remove units</div>
        <div class="list card" style="padding:10px;margin-bottom:8px">
          <div class="units-list" id="unitsList"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="add-btn" id="addUnitBtn">+ Add Unit</button>
            <button class="remove-btn" id="removeUnitBtn">- Remove Unit</button>
          </div>          
        </div>

        <!-- Scenario buttons (Enhancement E) -->
         <div class="section-title"><strong>Investment Return Variables</strong></div>
         <div class="small muted" style="margin-bottom:8px">Select a scenario or Enter Custom values</div>
          <div class="scenario-row" id="scenarioRow" style="margin-top:12px; margin-bottom:12px">
            <button id="bestBtn">Best</button>
            <button id="avgBtn">Average</button>
            <button id="worstBtn">Worst</button>
            <button id="customBtn" class="active">Custom</button>
          </div>

        <div class="form-row"><label>Vacancy Rate (%)</label><input id="vacancyRate" type="number" value="5" placeholder="%" /></div>
        <div class="form-row"><label>Annual Rent Increase (%)</label><input id="rentGrowth" type="number" value="2" step="0.1" placeholder="%" /></div>
        <div class="form-row"><label>Estimated Appreciation (%/yr)</label><input id="appreciation" type="number" value="4" step="0.01" placeholder="%" /></div>

        <hr style="opacity:0.08;margin:12px 0" />
        <div class="section-title"><strong>Operating Expenses (annual unless noted)</strong></div>
        <div class="form-row"><label data-tooltip="Depends on State & County, 1% default">Property Taxes ($/yr)</label><input id="propTaxes" type="number" value="3000" placeholder="$" /></div>
        <div class="form-row"><label>Insurance ($/yr)</label><input id="insurance" type="number" value="2000" placeholder="$" /></div>
        <div class="form-row"><label data-tooltip="<strong>Definition:</strong> Private Mortgage Insurance (PMI) protects lenders when equity is below 20%.<br><strong>Requirement:</strong> Must be paid for until 20% equity is reached. Will auto cancel at 78% equity.">Mortgage Insurance ($/yr)</label><input id="mortgageInsurance" type="number" placeholder="$" /></div>
        <div class="form-row"><label>Utilities ($/mo)</label><input id="utilities" type="number" placeholder="$" /></div>
        <div class="form-row"><label>Other Expenses (HOA, etc) ($/mo)</label><input id="otherExpenses" type="number" placeholder="$" /></div>
        <div class="form-row"><label>Maintenance (% of gross rent / yr)</label><input id="maintenancePct" type="number" value="8" step="0.1" placeholder="%" /></div>
        <div class="form-row"><label>Management Fee (% of rent)</label><input id="managementFeePct" type="number" value="8" step="0.1" placeholder="%" /></div>
        <div class="form-row"><label>Annual Expense Growth (%)</label><input id="expenseGrowth" type="number" value="0" step="0.1" placeholder="%" /></div>

        <hr style="opacity:0.08;margin:12px 0" />
        <div class="section-title"><strong>Capital Expenditures</strong></div>
        <div class="small muted">Add replacement cost & life</div>
        <div class="list card" style="padding:10px;margin-bottom:8px">
          <div class="capex-item-headers" style="display:flex; gap:12px; margin-bottom:4px;">
            <div class="small muted" style="flex:2;min-width:120px;white-space:nowrap">Item</div>
            <div class="small muted" style="flex:2;min-width:60px;white-space:nowrap">Amount ($)</div>
            <div class="small muted" style="flex:1;min-width:60px;white-space:nowrap">Life (yrs)</div>
            <div class="small muted" style="flex:1;min-width:60px;white-space:nowrap">Spend Year</div>
            <span class="help-icon" data-tooltip="Enter what year you will spend this from time of ownership">ℹ️</span>
          </div>
          <div class="capex-list" id="capexList"></div>
          <div style="display:flex;gap:8px;margin-top:8px"><button class="add-btn" id="addCapexBtn">+ Add CapEx Item</button></div>
        </div>

        <hr style="opacity:0.08;margin:12px 0" />
        <div class="section-title"><strong>Strategy & Taxes</strong></div>
        <div class="form-row"><label>Hold Period (yrs)</label><input id="holdYears" type="number" value="10" /></div>
        <div class="form-row"><label>Selling Costs (% of sale)</label><input id="sellingCostsPct" type="number" step="0.1" value="6" /></div>
        <div class="form-row"><label>Marginal Income Tax Rate (%)</label><input id="taxRate" type="number" step="0.1" value="24" /></div>
        <div class="form-row"><label>Capital Gains Tax Rate (%)</label><input id="capGainsRate" type="number" step="0.1" value="15" /></div>
        <div class="form-row"><label>Depreciation Recapture Rate (%)</label><input id="recaptureRate" type="number" step="0.1" value="25" /></div>
      </div>

      <!-- RIGHT: Results & Charts -->
      <div>
        <div class="card">
            <div class="section-title"><strong>Snapshot — Cashflow & Performance</strong></div>
            <div class="results" id="summaryTiles">

                <div class="tile" data-tooltip="<strong>Definition:</strong> Monthly principal + interest payment.<br><strong>Formula:</strong> Loan × [r(1+r)^n] / [(1+r)^n − 1]"><h3>Monthly Mortgage</h3><p id="monthlyPayment">$0</p></div>
                <div class="tile" data-tooltip="<strong>Definition:</strong> Gauges a property's profitablity<br><strong>Formula:</strong> Gross Monthly Rent / Purchase Price"><h3>1 % Rule</h3><p id="onePercentRule">0%</p></div>
                <div class="tile" data-tooltip="<strong>Definition:</strong> Years to recover total cash invested from cash flow.<br><strong>Formula:</strong> Initial Investment ÷ Annual Cash Flow"><h3>Payback (yrs)</h3><p id="payback">—</p></div>
            </div>
        </div>

        <div class="card">
            <div class="section-title"><strong>Performance Summary by Year</strong></div>
            <div style="margin-top:12px" class="section-title">
                <strong>Tax, Depreciation, & Cash calcs by year or over total hold strategy</strong>
            </div>

            <div style="display:flex;gap:12px;align-items:center;margin:12px 0;">
                <label for="holdStratSlider" style="min-width:72px;">Select year</label>
                <input id="holdStratSlider" type="range" min="1" max="2" value="1" style="flex:1">
                <div style="min-width:140px;text-align:right;"><span id="holdStratLabel">Year 1</span></div>
            </div>

            <div style="margin-top:12px" class="section-title"><strong>Cash Performance</strong></div>
            <div class="card2">                
                <div class="tile" data-tooltip="<strong>Definition:</strong> Monthly income after all expenses and debt service.<br><strong>Formula:</strong> (Effective Rent − Operating Expenses − Debt Service) ÷ 12"><h3>Net Monthly Cash Flow</h3><p id="netMonthly">$0</p></div>
                <div class="tile" data-tooltip="<strong>Definition:</strong> Combined annual expenses including debt and CapEx.<br><strong>Formula:</strong> Operating Expenses + Debt Service + CapEx"><h3>Total Annual Cash Outflow</h3><p id="allInOut">$0</p></div>
                <div class="tile" data-tooltip="<strong>Definition:</strong> Total annual income after expenses and mortgage.<br><strong>Formula:</strong> NOI − Debt Service"><h3>Net Annual Cash Flow</h3><p id="annualCash">$0</p></div>
                <div class="tile" data-tooltip="<strong>Definition:</strong> Annual cash return on total cash invested.<br><strong>Formula:</strong> Annual Cash Flow ÷ Initial Investment × 100"><h3>Cash-on-Cash ROI</h3><p id="cashOnCash">0%</p></div>
                <div class="tile" data-tooltip="<strong>Definition:</strong> Annual return on property value before financing.<br><strong>Formula:</strong> NOI ÷ Purchase Price × 100"><h3>Cap Rate</h3><p id="capRate">0%</p></div>
            </div>
            
            <div style="margin-top:12px" class="section-title"><strong>Tax Details</strong></div>
            <div class="card2">                
                <div class="tile" data-tooltip="<strong>Definition:</strong> Non-cash tax deduction from building value.<br><strong>Formula:</strong> (Purchase Price − Land Value) ÷ 27.5"><h3>Depreciation (yr)</h3><p id="depreciation">$0</p><div class="small muted">27.5-yr residential</div></div>
                <div class="tile" data-tooltip="<strong>Definition:</strong> Total expenses reducing taxable income.<br><strong>Formula:</strong> Operating Expenses + Interest + Depreciation"><h3>Total Deductible Expenses</h3><p id="totalDeduct">$0</p></div>
                <div class="tile" data-tooltip="<strong>Definition:</strong> Income reported for taxes after deductions.<br><strong>Formula:</strong> Effective Rent − (OpEx + Interest + Depreciation)"><h3>Taxable Income (yr)</h3><p id="taxableIncome">$0</p></div>
                <div class="tile" data-tooltip="<strong>Definition:</strong> Estimated tax savings from deductible expenses.<br><strong>Formula:</strong> (Depreciation + Interest + Other Deductions) × Tax Rate"><h3>Tax Shield (est)</h3><p id="taxShield">$0</p></div>
                <div class="tile" data-tooltip="<strong>Definition:</strong> Estimated income tax owed for the year.<br><strong>Formula:</strong> Taxable Income × Income Tax Rate"><h3>Income Tax Liability</h3><p id="taxLiability">$0</p></div>  
            </div>

            
        </div>

        <div style="margin-top:12px" class="card">
            <div class="section-title"><strong>Hold-Period Strategy Summary – <span id="holdYearsLabel"> yrs</span></strong></div>
            <div style="display:flex;gap:12px;align-items:start">
            <div class="results hold-summary">
                <div class="tile" data-tooltip="<strong>Definition:</strong> Total cumulative cash flow over hold period.<br><strong>Formula:</strong> Σ Annual Cash Flow"><h3>Total Cash Flow (hold)</h3><p id="totalCashFlow">$0</p></div>
                <div class="tile" data-tooltip="<strong>Definition:</strong> Cash received from sale after loan payoff and selling costs.<br><strong>Formula:</strong> Sale Price − Loan Balance − Selling Costs"><h3>Net Sale Proceeds</h3><p id="netSale">$0</p></div>
                <div class="tile" data-tooltip="<strong>Definition:</strong> Profit before taxes (cash flow + sale − invested).<br><strong>Formula:</strong> (Cumulative Cash Flow + Net Sale − Initial Investment)"><h3>Total Gain (before tax)</h3><p id="totalGain">$0</p></div>
                <div class="tile" data-tooltip="<strong>Definition:</strong> Net profit after all taxes.<br><strong>Formula:</strong> Total Gain − Taxes"><h3>Estimated After-Tax Gain</h3><p id="afterTaxGain">$0</p></div>
                <div class="tile" data-tooltip="<strong>Definition:</strong> Total after-tax return on investment.<br><strong>Formula:</strong> After-Tax Gain ÷ Initial Investment × 100"><h3>Total ROI (hold)</h3><p id="totalROI">0%</p></div>
                <div class="tile" data-tooltip="<strong>Definition:</strong> Average annual return compounded over hold period.<br><strong>Formula:</strong> [(Final ÷ Initial)^(1/Years) − 1] × 100"><h3>Annualized ROI (CAGR)</h3><p id="annualROI">0%</p></div>
            </div>

            <!-- ROI pie on right -->
            <div style="width:280px;display:flex;flex-direction:column;align-items:center;justify-content:center;margin:auto;">
            <div style="font-size:13px;color:var(--muted);margin-bottom:8px;text-align:center;">
                Return Composition (approx)
            </div>
            <canvas id="roiPie" style="width:100%;height:220px;display:block;margin:0;"></canvas>
            </div>
            </div>

          <div style="margin-top:12px" class="section-title"><strong>Projection Charts</strong></div>
          <div class="chart-wrap">
            <div><canvas id="projChart" style="max-height:160px;margin:0;width:100%;"></canvas></div>
            <div><canvas id="cashflowChart" style="max-height:160px;margin:0;width:100%;"></canvas></div>
          </div>
        </div>

        <div style="margin-top:12px" class="card">
          <div class="section-title"><strong>Detailed Values</strong></div>
          <button id="exportBtn" class="btn">Export Results to CSV</button>
          <div id="detailList" class="list" style="margin-top:8px"></div>
        </div>

        <footer style="margin-top:12px"><div class="small muted">Prototype: uses simplified tax approximations (inputs for capital gains & recapture rates provided).</div></footer>
      </div>
    </div>
  </div>

<script>
  /* Utilities */
  const $ = id => document.getElementById(id);
  const money2 = v => (Number(v) || 0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});

  /* State */
  const unitsList = $('unitsList');
  const capexList = $('capexList');
  const inputsCard = $('inputsCard');
  const numUnitsInput = $('numUnits');

  let unitRents = [];
  let lastDetail = null; // <-- store latest detail for export & charts

  /* Scenario presets (example national-ish defaults) */
  const SCENARIOS = {
    best: { vacancy: 3, rentGrowth: 4, appreciation: 6, maintenance: 6, expenseGrowth: 0 },
    avg:  { vacancy: 5, rentGrowth: 2, appreciation: 4, maintenance: 8, expenseGrowth: 1 },
    worst:{ vacancy: 8, rentGrowth: 0, appreciation: 1, maintenance: 12, expenseGrowth: 2 }
  };

  /* Create unit input */
  function createUnitInput(index, value='') {
    const wrap = document.createElement('div'); wrap.className = 'unit-item';
    const lbl = document.createElement('div'); lbl.className='small muted'; lbl.style.minWidth='60px'; lbl.textContent = 'Unit ' + (index+1) + ' ($)';
    const inp = document.createElement('input'); inp.type='number'; inp.value=value; inp.placeholder='$'; inp.dataset.unitIndex=index; inp.style.flex='1';
    wrap.appendChild(lbl); wrap.appendChild(inp); return wrap;
  }

  /* Down payment controls */
  const purchasePriceInput = $('purchasePrice');
  const downPaymentValueInput = $('downPaymentValue');
  const downPaymentPercentInput = $('downPaymentPercent');
  const amountButton = $('amountButton');
  const percentButton = $('percentButton');
  let downPaymentMode = "percent";

  function updateDownPaymentFromAmount() {
    const purchasePrice = parseFloat(purchasePriceInput.value) || 0;
    const amount = parseFloat(downPaymentValueInput.value) || 0;
    const percent = purchasePrice ? (amount / purchasePrice) * 100 : 20;
    downPaymentPercentInput.value = percent.toFixed(1);
  }
  function updateDownPaymentFromPercent() {
    const purchasePrice = parseFloat(purchasePriceInput.value) || 0;
    const percent = parseFloat(downPaymentPercentInput.value) || 20;
    const amount = (percent / 100) * purchasePrice;
    downPaymentValueInput.value = amount.toFixed(0);
  }
  function refreshDownPaymentInputs(){
    if (downPaymentMode === "amount") {
      downPaymentValueInput.removeAttribute("readonly");
      downPaymentPercentInput.setAttribute("readonly", true);
      updateDownPaymentFromAmount();
      amountButton.classList.add("active"); percentButton.classList.remove("active");
    } else {
      downPaymentPercentInput.removeAttribute("readonly");
      downPaymentValueInput.setAttribute("readonly", true);
      updateDownPaymentFromPercent();
      percentButton.classList.add("active"); amountButton.classList.remove("active");
    }
  }
  amountButton.addEventListener('click', ()=>{ downPaymentMode='amount'; refreshDownPaymentInputs(); });
  percentButton.addEventListener('click', ()=>{ downPaymentMode='percent'; refreshDownPaymentInputs(); });
  purchasePriceInput.addEventListener('input', refreshDownPaymentInputs);
  downPaymentValueInput.addEventListener('input', ()=>{ if (downPaymentMode==='amount') updateDownPaymentFromAmount(); });
  downPaymentPercentInput.addEventListener('input', ()=>{ if (downPaymentMode==='percent') updateDownPaymentFromPercent(); });

  /* Scenario buttons */
  const bestBtn = $('bestBtn'), avgBtn = $('avgBtn'), worstBtn = $('worstBtn'), customBtn = $('customBtn');
  const scenarioButtons = [bestBtn, avgBtn, worstBtn, customBtn];
  function setActiveScenario(name) {
    scenarioButtons.forEach(b => b.classList.remove('active'));
    if (name === 'best') bestBtn.classList.add('active');
    else if (name === 'avg') avgBtn.classList.add('active');
    else if (name === 'worst') worstBtn.classList.add('active');
    else customBtn.classList.add('active');
  }
  function applyScenario(name) {
    const s = SCENARIOS[name];
    if (!s) return;
    $('vacancyRate').value = s.vacancy;
    $('rentGrowth').value = s.rentGrowth;
    $('appreciation').value = s.appreciation;
    $('maintenancePct').value = s.maintenance;
    $('expenseGrowth').value = s.expenseGrowth;
    setActiveScenario(name);
    calculateAll();
  }
  bestBtn.addEventListener('click', ()=>applyScenario('best'));
  avgBtn.addEventListener('click', ()=>applyScenario('avg'));
  worstBtn.addEventListener('click', ()=>applyScenario('worst'));
  customBtn.addEventListener('click', ()=>setActiveScenario('custom'));

  // If user types in any of the scenario inputs -> set custom active
  ['vacancyRate','rentGrowth','appreciation','maintenancePct','expenseGrowth'].forEach(id=>{
    $(id).addEventListener('input', ()=> setActiveScenario('custom'));
  });

  /* Unit management */
  function refreshUnitsFromState() {
    const n = Math.max(0, parseInt(numUnitsInput.value || 0));
    if (!unitRents.length) {
      const existing = unitsList.querySelectorAll('input[type="number"]');
      if (existing.length) unitRents = Array.from(existing).map(i=>Number(i.value||''));
    }
    const old = unitRents.slice(0);
    unitRents.length = 0;
    for (let i=0;i<n;i++){
      if (old[i] !== undefined) unitRents[i] = old[i];
      else if (old.length) unitRents[i] = old[old.length-1] || '';
      else unitRents[i] = '';
    }
    unitsList.innerHTML = '';
    for (let i=0;i<n;i++) unitsList.appendChild(createUnitInput(i, unitRents[i]));
  }

  /* Events & delegation */
  inputsCard.addEventListener('input', (ev)=>{
    const t = ev.target; if (!t) return;
    if (t.dataset && t.dataset.unitIndex !== undefined) {
      const idx = Number(t.dataset.unitIndex); unitRents[idx] = Number(t.value || 0);
      setActiveScenario('custom'); // editing rents = custom
    }
    calculateAll();
  });

  inputsCard.addEventListener('keydown', (ev)=>{ if (ev.key!=='Enter') return; const t=ev.target; if(!t||t.tagName!=='INPUT') return; ev.preventDefault(); const all = Array.from(inputsCard.querySelectorAll('input')); const idx = all.indexOf(t); if(idx>=0 && idx < all.length -1) all[idx+1].focus(); calculateAll(); });

  $('addUnitBtn').addEventListener('click', ()=>{ const cur = Math.max(0, parseInt(numUnitsInput.value||0)); numUnitsInput.value = cur+1; refreshUnitsFromState(); calculateAll(); });
  $('removeUnitBtn').addEventListener('click', ()=>{ const cur = Math.max(0, parseInt(numUnitsInput.value||0)); const next = Math.max(0,cur-1); numUnitsInput.value = next; unitRents.length = next; refreshUnitsFromState(); calculateAll(); });
  numUnitsInput.addEventListener('change', ()=>{ refreshUnitsFromState(); calculateAll(); });

  $('addCapexBtn').addEventListener('click', ()=>{ capexList.appendChild(createCapexItem('','', '','')); calculateAll(); });

  /* capex item creator */
  function createCapexItem(name='', cost='', life='', spendYear='') {
    const wrap = document.createElement('div'); wrap.className='capex-item';
    const nameI = document.createElement('input'); nameI.type='text'; nameI.placeholder='Item'; nameI.value=name; nameI.style.width='40%';
    const costI = document.createElement('input'); costI.type='number'; costI.placeholder='$'; costI.value=cost; costI.style.width='30%';
    const lifeI = document.createElement('input'); lifeI.type='number'; lifeI.value=life; lifeI.style.width='20%'; lifeI.placeholder='yrs';
    const spendYearI = document.createElement('input'); spendYearI.type='number'; spendYearI.placeholder='yr'; spendYearI.value=spendYear; spendYearI.style.width='20%';
    const btn = document.createElement('button'); btn.type='button'; btn.className='remove-btn'; btn.textContent='x'; btn.title='Remove item';
    btn.addEventListener('click', ()=>{ wrap.remove(); calculateAll(); });
    wrap.appendChild(nameI); wrap.appendChild(costI); wrap.appendChild(lifeI); wrap.appendChild(spendYearI); wrap.appendChild(btn);
    return wrap;
  }

  /* Charts */
  let projChart = null, cashflowChart=null, roiChart=null;
  function ensureLineChart(canvasId, labels=[], datasets=[], opts={}) {
    const ctx = $(canvasId).getContext('2d');
    if (canvasId === 'projChart') {
      if (!projChart) projChart = new Chart(ctx, { type:'line', data:{labels,datasets}, options: Object.assign({responsive:true,plugins:{legend:{position:'top'}},interaction:{mode:'index',intersect:false}}, opts) });
      else { projChart.data.labels = labels; projChart.data.datasets = datasets; projChart.update(); }
    } else {
      if (!cashflowChart) cashflowChart = new Chart(ctx, { type:'bar', data:{labels,datasets}, options: Object.assign({responsive:true,plugins:{legend:{position:'top'}},scales:{x:{stacked:true},y:{stacked:true}}}, opts) });
      else { cashflowChart.data.labels = labels; cashflowChart.data.datasets = datasets; cashflowChart.update(); }
    }
  }
  function ensurePieChart(canvasId, labels=[], data=[]) {
    const ctx = $(canvasId).getContext('2d');
    if (!roiChart) roiChart = new Chart(ctx, { type:'pie', data:{labels,datasets:[{data, backgroundColor:['#2563eb','#16a34a','#f59e0b','#6b7280']}] , }, options:{responsive:true,plugins:{legend:{position:'bottom'}}} });
    else { roiChart.data.labels = labels; roiChart.data.datasets[0].data = data; roiChart.update(); }
  }

  /* Gather inputs */
  function gatherInputs() {
    const getNum = id => Number($(id)?.value || 0);
    const obj = {
      purchasePrice: getNum('purchasePrice'),
      appraisedValue: getNum('appraisedValue'),
      dpVal: getNum('downPaymentValue'),
      interestRate: getNum('interestRate'),
      loanTerm: getNum('loanTerm'),
      closingCosts: getNum('closingCosts'),
      sellerPaidClosingCosts: getNum('sellerpaidclosingCosts'),
      landValue: getNum('landValue'),
      vacancyRate: getNum('vacancyRate') / 100,
      rentGrowth: getNum('rentGrowth') / 100,
      appreciation: getNum('appreciation') / 100,
      propTaxes: getNum('propTaxes'),
      insurance: getNum('insurance'),
      mortgageInsurance: getNum('mortgageInsurance'),
      utilities: getNum('utilities') * 12,
      otherExpenses: getNum('otherExpenses') * 12,
      maintenancePct: getNum('maintenancePct') / 100,
      managementFeePct: getNum('managementFeePct') / 100,
      expenseGrowth: getNum('expenseGrowth') / 100,
      holdYears: Math.max(1, Math.floor(getNum('holdYears'))),
      sellingCostsPct: getNum('sellingCostsPct') / 100,
      taxRate: getNum('taxRate') / 100,
      capGainsRate: getNum('capGainsRate') / 100,
      recaptureRate: getNum('recaptureRate') / 100
    };

    obj.capexItems = [];
    capexList.querySelectorAll('.capex-item').forEach(div=>{
      const inputs = Array.from(div.querySelectorAll('input'));
      if (inputs.length >= 4) {
        const name = inputs[0].value || '';
        const cost = Number(inputs[1].value || 0);
        const life = Number(inputs[2].value || 0);
        const spendYear = Number(inputs[3].value || 0);
        obj.capexItems.push({name,cost,life,spendYear});
      }
    });

    obj.unitRents = unitRents.slice();
    obj.grossAnnualRent = obj.unitRents.reduce((a,b)=>a+(b||0),0) * 12;
    return obj;
  }

  /* Financial helpers */
  function monthlyMortgage(P, annualRate, years) {
    P = Number(P) || 0;
    const r = (Number(annualRate) || 0) / 100;
    const n = (Number(years) || 0) * 12;
    if (n === 0) return 0;
    if (!r) return P / n;
    const m = r / 12;
    return (P * m) / (1 - Math.pow(1 + m, -n));
  }
  function amortSchedule(loanAmount, annualRate, years) {
    loanAmount = Number(loanAmount) || 0;
    const monthly = monthlyMortgage(loanAmount, annualRate, years);
    const mRate = (Number(annualRate) || 0) / 100 / 12;
    let bal = loanAmount;
    const schedule = [];
    for (let y=1;y<=years;y++){
      let yearInterest=0, yearPrincipal=0;
      for (let m=0;m<12;m++){
        const interest = bal * mRate;
        const principal = Math.max(0, monthly - interest);
        yearInterest += interest; yearPrincipal += principal;
        bal = Math.max(0, bal - principal);
      }
      schedule.push({year:y, interestPaid:yearInterest, principalPaid:yearPrincipal, endBalance:bal});
    }
    return schedule;
  }

/* Main calculation */
function calculateAll(){
    const I = gatherInputs();

    // loan & payments
    const loanAmount = Math.max(0, I.purchasePrice - I.dpVal);
    const monthlyPayment = monthlyMortgage(loanAmount, I.interestRate, I.loanTerm);
    const annualDebtService = monthlyPayment * 12;
    const amort = amortSchedule(loanAmount, I.interestRate, I.loanTerm);

    // --- Mortgage Insurance (PMI) for snapshot calculations ---
    // PMI input is monthly; include in snapshots if starting LTV > 80%
    const mortgageInsuranceAnnual = Number(I.mortgageInsurance*12 || 0);
    const startingLoanBalance = loanAmount; // at origination
    const startingEquityRatio = I.purchasePrice ? (1 - (startingLoanBalance / I.purchasePrice)) : 0;
    const pmiActiveStart = mortgageInsuranceAnnual > 0 && startingEquityRatio < 0.20;
    const mortgageInsuranceCostStart = pmiActiveStart ? mortgageInsuranceAnnual : '0';
   
    // operating items (snapshot-level, include PMI)
    const maintenance = I.grossAnnualRent * I.maintenancePct;
    const managementFee = I.grossAnnualRent * I.managementFeePct;
    const operatingExpenses = I.propTaxes + I.insurance + I.utilities + I.otherExpenses + maintenance + managementFee + mortgageInsuranceAnnual;
       
    // income, NOI, cashflow (snapshot)
    const effectiveGrossRent = I.grossAnnualRent * (1 - I.vacancyRate);
    const NOI = effectiveGrossRent - operatingExpenses;
    const annualCashFlow = NOI - annualDebtService;
    const netMonthly = annualCashFlow / 12;
    const capRate = I.purchasePrice ? (NOI / I.purchasePrice) * 100 : 0;
    const initialInvestment = I.dpVal + I.closingCosts - I.sellerPaidClosingCosts;
    const cashOnCash = initialInvestment ? (annualCashFlow / initialInvestment) * 100 : 0;
    const paybackYears = annualCashFlow > 0 ? (initialInvestment / annualCashFlow) : Infinity;
    const onePercentRule = 5/I.purchasePrice;


    /* depreciation & taxes */
    const firstYearCapexDep = I.capexItems.reduce((s,c)=>{
      const spend = Number(c.spendYear) || 0;
      return s + ((spend === 1 && c.life > 0) ? (c.cost / c.life) : 0);
    }, 0);
    const depreciableBasis = Math.max(0, I.purchasePrice - I.landValue);
    const depreciationAnnual = depreciableBasis / 27.5;
    const firstYearInterest = (amort[0] && amort[0].interestPaid) ? amort[0].interestPaid : 0;

    /* projection loop */
    const years = Math.max(1, I.holdYears);
    let yearRents = I.grossAnnualRent;
    let cumulativeCashFlow = 0;
    const detail = [];
    const yearlySalePrices = [];
    const yearlyLoanBalances = [];
    let totalIncomeTaxPaid = 0;
    let totalDepreciationTaken = 0;

    const amortForYears = amortSchedule(loanAmount, I.interestRate, I.loanTerm);

    for (let y = 1; y <= years; y++) {
    if (y > 1) yearRents *= (1 + I.rentGrowth);

    // --- amortization balance for this year (needed for equity/PMI decisions)
    const bal = (amortForYears[y - 1]) ? amortForYears[y - 1].endBalance : 0;

    // --- Mortgage Insurance (PMI) logic ---
    // annual PMI input from user (0 if not used)
    const mortgageInsuranceAnnual = Number(I.mortgageInsurance*12 || 0);
    // equity ratio = (owner equity) ÷ purchase price
    const equityRatio = I.purchasePrice ? (1 - (bal / I.purchasePrice)) : 0;
    // PMI active if user entered PMI amount AND equity < 20%
    const pmiActive = mortgageInsuranceAnnual > 0 && (equityRatio < 0.199999);
    const mortgageInsuranceCost = pmiActive ? mortgageInsuranceAnnual : 0;

    // --- Yearly operating items ---
    const maintenanceY = yearRents * I.maintenancePct;
    const managementFeeY = yearRents * I.managementFeePct;
    const operatingExpensesY = I.propTaxes + I.insurance + I.utilities + I.otherExpenses + maintenanceY + managementFeeY + mortgageInsuranceCost;
    const effGross = yearRents * (1 - I.vacancyRate);
    const NOIy = effGross - operatingExpensesY;
    const capexSpent = I.capexItems.reduce((s, c) => s + (c.spendYear === y ? c.cost : 0), 0);
    const cashFlowY = NOIy - annualDebtService - capexSpent;
    cumulativeCashFlow += cashFlowY;

    const interestY = (amortForYears[y - 1] && amortForYears[y - 1].interestPaid) ? amortForYears[y - 1].interestPaid : 0;
    const annualCapExDep = I.capexItems.reduce((sum, c) => {
        const spend = Number(c.spendYear) || 0;
        if (spend && spend <= y && c.life > 0) return sum + (c.cost / c.life);
        return sum;
    }, 0);

    const taxableY = effGross - (operatingExpensesY + depreciationAnnual + interestY + annualCapExDep + mortgageInsuranceCost);
    const taxY = taxableY > 0 ? taxableY * I.taxRate : 0;
    totalIncomeTaxPaid += taxY;
    totalDepreciationTaken += depreciationAnnual + annualCapExDep;

    yearlyLoanBalances.push(bal);

    const baseVal = I.appraisedValue || I.purchasePrice;
    const salePrice = baseVal * Math.pow(1 + I.appreciation, y);
    yearlySalePrices.push(salePrice);

    detail.push({
        year: y,
        rent: effGross,
        operatingExpenses: operatingExpensesY,
        NOI: NOIy,
        cashFlow: cashFlowY,
        cumulativeCashFlow,
        loanBalance: bal,
        salePrice,
        depreciation: depreciationAnnual + annualCapExDep,
        taxableIncome: taxableY,
        totalDeductible: operatingExpensesY + depreciationAnnual + interestY + annualCapExDep,
        allInCashOut: operatingExpensesY + annualDebtService + capexSpent,
        taxes: taxY,
        netMonthly: cashFlowY / 12,
        capRate: I.purchasePrice ? (NOIy / I.purchasePrice) * 100 : 0,
        cashOnCash: initialInvestment ? (cashFlowY / initialInvestment) * 100 : 0
    });
    }


    /* sale calcs */
    const finalSalePrice = (yearlySalePrices[years-1] || (I.appraisedValue || I.purchasePrice)) || 0;
    const loanBalanceAtSale = yearlyLoanBalances[years-1] || 0;
    const sellingCosts = finalSalePrice * I.sellingCostsPct;
    const netSaleProceedsBeforeTax = finalSalePrice - loanBalanceAtSale - sellingCosts;
    let capitalGain = finalSalePrice - I.purchasePrice - totalDepreciationTaken;
    if (capitalGain < 0) capitalGain = 0;
    const recaptureTax = totalDepreciationTaken * I.recaptureRate;
    const capGainsTax = capitalGain * I.capGainsRate;
    const taxesOnSale = recaptureTax + capGainsTax;
    const totalTaxes = totalIncomeTaxPaid + taxesOnSale;
    const totalGainBeforeTax = cumulativeCashFlow + netSaleProceedsBeforeTax - initialInvestment;
    const afterTaxGain = totalGainBeforeTax - totalTaxes;
    const totalROI = initialInvestment ? ((afterTaxGain / initialInvestment) * 100) : 0;
    const finalValue = initialInvestment + afterTaxGain;
    const annualizedROI = (initialInvestment && finalValue > 0) ? (Math.pow((finalValue / initialInvestment), 1 / years) - 1) * 100 : 0;

    /* snapshot slider */
    updateHoldStratSliderMax();
    const sel = Number($('holdStratSlider').value) || 1;
    let snap = { depreciation:0, netMonthly:0, cashFlowY:0, capRate:0, cashOnCash:0, taxableIncome:0, totalDeductible:0, taxes:0, allInCashOut:0 };
    if (sel === years + 1) {
    // Calculate AVERAGES across the entire hold period
    const totals = detail.reduce((acc, d) => {
        acc.depreciation += d.depreciation || 0;
        acc.netMonthly += d.netMonthly || 0;
        acc.cashFlow += d.cashFlow || 0;
        acc.capRate += d.capRate || 0;
        acc.cashOnCash += d.cashOnCash || 0;
        acc.taxableIncome += d.taxableIncome || 0;
        acc.totalDeductible += d.totalDeductible || 0;
        acc.taxes += d.taxes || 0;
        acc.allInCashOut += d.allInCashOut || 0;
        return acc;
    }, { depreciation:0, netMonthly:0, cashFlow:0, capRate:0, cashOnCash:0, taxableIncome:0, totalDeductible:0, taxes:0, allInCashOut:0 });

    // compute averages
    snap = {
        depreciation: totals.depreciation / years,
        netMonthly: totals.cashFlow / (years * 12), // average monthly cash flow
        cashFlow: totals.cashFlow / years,
        capRate: totals.capRate / years,
        cashOnCash: totals.cashOnCash / years,
        taxableIncome: totals.taxableIncome / years,
        totalDeductible: totals.totalDeductible / years,
        taxes: totals.taxes / years,
        allInCashOut: totals.allInCashOut / years,
        isAverage: true
    };
    } else {
    snap = detail[sel - 1] || { depreciation:0, netMonthly:0, cashFlow:0, capRate:0, cashOnCash:0, taxableIncome:0, totalDeductible:0, taxes:0, allInCashOut:0 };
    snap.isAverage = false;
    }


    /* Update snapshot tiles & hold summary tiles */
    $('monthlyPayment').textContent = '$' + money2(monthlyPayment || 0);
    $('onePercentRule').textContent = ((100 * (I.grossAnnualRent / 12) / I.purchasePrice) || 0).toFixed(2) + '%';
    $('payback').textContent = (paybackYears === Infinity) ? '—' : paybackYears.toFixed(1);

    /* update slider tiles Cash performance*/
    $('netMonthly').textContent = '$' + money2(snap.netMonthly || 0);
    $('allInOut').textContent = '$' + money2(snap.allInCashOut || 0);    
    $('annualCash').textContent = '$' + money2(snap.cashFlow|| 0);
    $('cashOnCash').textContent = (snap.cashOnCash || 0).toFixed(2) + '%';
    $('capRate').textContent = (snap.capRate || 0).toFixed(2) + '%';

    // Add or remove "(avg)" indicator on cash performance labels
    const cashLabels = [
    ['netMonthly', 'Net Monthly Cash Flow'],
    ['allInOut', 'Total Annual Cash Outflow'],
    ['annualCash', 'Net Annual Cash Flow'],
    ['cashOnCash', 'Cash-on-Cash ROI'],
    ['capRate', 'Cap Rate']
    ];

    cashLabels.forEach(([id, baseLabel]) => {
    const tile = $(id).closest('.tile');
    const h3 = tile ? tile.querySelector('h3') : null;
    if (h3) {
        h3.textContent = baseLabel + (snap.isAverage ? ' (avg)' : '');
    }
    });

    /* update slider tiles tax details*/
    $('depreciation').textContent = '$' + money2(snap.depreciation || 0);
    $('totalDeduct').textContent = '$' + money2(snap.totalDeductible || 0);   
    $('taxableIncome').textContent = '$' + money2(snap.taxableIncome || 0);  
    const estimatedTaxShield = ((snap.depreciation || 0) + (firstYearInterest || 0) + (firstYearCapexDep || 0)) * (I.taxRate || 0);
    $('taxShield').textContent = '$' + money2(estimatedTaxShield || 0);  
    $('taxLiability').textContent = '$' + money2(snap.taxes || 0);
        

    //update hold period tiles & label
    $('totalCashFlow').textContent = '$' + money2(cumulativeCashFlow || 0);
    $('netSale').textContent = '$' + money2(netSaleProceedsBeforeTax || 0);
    $('totalGain').textContent = '$' + money2(totalGainBeforeTax || 0);
    $('afterTaxGain').textContent = '$' + money2(afterTaxGain || 0);
    $('totalROI').textContent = (totalROI || 0).toFixed(1) + '%';
    $('annualROI').textContent = (annualizedROI || 0).toFixed(1) + '%';
    $('holdYearsLabel').textContent = `${I.holdYears} yrs`;
           
    //VISUALS - CHARTS & TABLE
    /* ROI pie */
    // principal paid total across amortForYears limited to hold years
    const principalPaidTotal = amortForYears.slice(0, years).reduce((s,a)=> s + (a.principalPaid || 0), 0);
    const appreciationTotal = finalSalePrice - I.purchasePrice;
    const cashflowTotal = cumulativeCashFlow;
    const totalTaxShieldEstimate = totalDepreciationTaken * I.taxRate;
    const pieLabels = ['Appreciation','Loan Paydown','Cash Flow','Tax Shield (est)'];
    const pieData = [
      Math.max(0, appreciationTotal),
      Math.max(0, principalPaidTotal),
      Math.max(0, cashflowTotal),
      Math.max(0, totalTaxShieldEstimate)
    ];
    ensurePieChart('roiPie', pieLabels, pieData);

    /* update projection charts */
    const labels = detail.map(d => 'Y' + d.year);
    const valueSeries = detail.map(d => Number(d.salePrice.toFixed(2)));
    const equitySeries = detail.map(d => Number((d.salePrice - d.loanBalance).toFixed(2)));
    const cashflowSeries = detail.map(d => Number(d.cumulativeCashFlow.toFixed(2)));
        
    // left: projection (line)
    ensureLineChart('projChart', labels, [
      { label:'Sale Price (proj)', data: valueSeries, borderColor:'#2563eb', fill:false, tension:0.2 },
      { label:'Equity', data: equitySeries, borderColor:'#16a34a', fill:false, tension:0.2 },
      { label:'Cumulative Cashflow', data: cashflowSeries, borderColor:'#f59e0b', fill:false, tension:0.2 }
    ]);

    // --- Hold-Period Investment Performance (Bar Chart) ---
    const ctxPerf = $('cashflowChart').getContext('2d');
    if (cashflowChart) cashflowChart.destroy();
    cashflowChart = new Chart(ctxPerf, {
    type: 'bar',
    data: {labels: ['Cap Rate', 'Cash-on-Cash ROI', 'IRR (Annualized ROI)'],datasets: [{label: 'Performance (%)',data: [capRate, cashOnCash, annualizedROI],backgroundColor: ['#2563eb', '#16a34a', '#f59e0b']}]},
    options: {responsive: true,plugins: { legend: { display: false }, title: { display: true, text: 'Investment Performance (Hold Period)' } },scales: {y: {ticks: { callback: v => v + '%' },beginAtZero: true}}}
    });

    /* render detail table */
    lastDetail = detail; // store globally for export & other uses
    const detailDiv = $('detailList');
    detailDiv.innerHTML = '';
    const table = document.createElement('table');
    table.style.width = '100%'; table.style.borderCollapse = 'collapse';
    table.innerHTML = `<thead><tr style="text-align:left;color:var(--muted);font-size:13px"><th>Year</th><th>Rent</th><th>OpEx</th><th>NOI</th><th>Cash Flow</th><th>Cumulative CF</th><th>Loan Bal</th><th>Sale Price</th><th>Depreciation</th><th>Taxable Income</th><th>Tax Deductions</th><th>Tax Liability</th><th>Cash Out</th></tr></thead>`;
    const tb = document.createElement('tbody');
    detail.forEach(r=>{
      const tr = document.createElement('tr');
      tr.style.borderTop='1px solid rgba(9,30,66,0.04)';
      tr.innerHTML = `<td style="padding:6px">${r.year}</td>
        <td style="padding:6px">$${money2(r.rent)}</td>
        <td style="padding:6px">$${money2(r.operatingExpenses)}</td>
        <td style="padding:6px">$${money2(r.NOI)}</td>
        <td style="padding:6px">$${money2(r.cashFlow)}</td>
        <td style="padding:6px">$${money2(r.cumulativeCashFlow)}</td>
        <td style="padding:6px">$${money2(r.loanBalance)}</td>
        <td style="padding:6px">$${money2(r.salePrice)}</td>
        <td style="padding:6px">$${money2(r.depreciation)}</td>
        <td style="padding:6px">$${money2(r.taxableIncome)}</td>
        <td style="padding:6px">$${money2(r.totalDeductible)}</td>
        <td style="padding:6px">$${money2(r.taxes)}</td>
        <td style="padding:6px">$${money2(r.allInCashOut)}</td>`;
      tb.appendChild(tr);
    });
    table.appendChild(tb);
    detailDiv.appendChild(table);   
  } // calculateAll

  /* Slider & tax table wiring */
  const holdStratSlider = $('holdStratSlider');
  const holdStratLabel = $('holdStratLabel');
  const holdYearsInput = $('holdYears');

  function updateHoldStratSliderMax() {
    const years = Math.max(1, Number(holdYearsInput.value) || 1);
    holdStratSlider.max = years + 1;
    if (Number(holdStratSlider.value) > holdStratSlider.max) holdStratSlider.value = holdStratSlider.max;
  }
  function updateHoldStratLabel() {
    const years = Math.max(1, Number(holdYearsInput.value) || 1);
    const val = Number(holdStratSlider.value);
    holdStratLabel.textContent = (val === years + 1) ? `Total (${years} yrs)` : `Year ${val}`;
  }
  function initHoldStratSlider() {
    updateHoldStratSliderMax();
    holdStratSlider.addEventListener('input', ()=>{ updateHoldStratLabel(); calculateAll(); });
    holdYearsInput.addEventListener('change', ()=>{ updateHoldStratSliderMax(); updateHoldStratLabel(); calculateAll(); });
    updateHoldStratLabel();
  }

  /* Initialization */
  (function init(){
    const initialNum = Math.max(0, parseInt(numUnitsInput.value || 0));
    const existing = unitsList.querySelectorAll('input[type="number"]');
    if (existing.length) unitRents = Array.from(existing).map(i => Number(i.value || 0));
    if (unitRents.length < initialNum) {
      const last = unitRents.length ? unitRents[unitRents.length - 1] : '';
      while (unitRents.length < initialNum) unitRents.push(last);
    }
    refreshUnitsFromState();

    // global small listeners
    document.querySelectorAll('input, select').forEach(el => el.addEventListener('input', ()=>{ calculateAll(); }));

    initHoldStratSlider();

    // default scenario to Average on load
    applyScenario('avg');
    refreshDownPaymentInputs();
  })();

  /* Export button - uses lastDetail */
  $('exportBtn').addEventListener('click', ()=>{
    if (!lastDetail || !lastDetail.length) { alert('No results to export yet. Change inputs and try again.'); return; }
    const rows = lastDetail.map(d => [
      d.year, d.rent, d.operatingExpenses, d.NOI, d.cashFlow, d.cumulativeCashFlow, d.loanBalance, d.salePrice, d.depreciation, d.taxableIncome, d.totalDeductible, d.taxes, d.allInCashOut
    ]);
    const csv = 'Year,Rent,OpEx,NOI,CashFlow,CumulativeCF,LoanBal,SalePrice,Depreciation,TaxableIncome,TaxDeductions,TaxLiability,CashOut\n' + rows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'real_estate_projection.csv';
    a.click();
  });

// --- Enable real HTML tooltips (tiles + labels) ---
document.addEventListener('mouseover', e => {
  const target = e.target.closest('.tile[data-tooltip], label[data-tooltip]');
  if (!target) return;
  const html = target.getAttribute('data-tooltip');
  let tip = document.querySelector('#customTooltip');
  if (!tip) {
    tip = document.createElement('div');
    tip.id = 'customTooltip';
    tip.style.position = 'fixed';
    tip.style.background = '#111827';
    tip.style.color = '#f9fafb';
    tip.style.padding = '8px 10px';
    tip.style.borderRadius = '8px';
    tip.style.fontSize = '12px';
    tip.style.lineHeight = '1.3';
    tip.style.maxWidth = '260px';
    tip.style.pointerEvents = 'none';
    tip.style.zIndex = '9999';
    tip.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';
    document.body.appendChild(tip);
  }

  tip.innerHTML = html;

  const move = ev => {
    tip.style.top = (ev.clientY + 16) + 'px';
    tip.style.left = (ev.clientX + 16) + 'px';
  };
  move(e);

  document.addEventListener('mousemove', move);

  target.addEventListener('mouseleave', () => {
    tip.remove();
    document.removeEventListener('mousemove', move);
  }, { once: true });
});

</script>
</body>
</html>
