<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Retirement Simulator — Smart Advisor (v3)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  /* ------------------------
     Basic visual styles
     ------------------------ */
  :root{
    --bg:#f6fafc;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#2563eb;
    --accent2:#ea580c;
    --ok:#10b981;
    --danger:#ef4444;
    --surface:#f8fafc;
    --border:#e6eef8;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#f8fbff 0%,#f6fafc 100%);color:#0f172a}
  .app{max-width:1200px;margin:18px auto;padding:18px}
  h1{margin:0 0 6px;font-weight:700}
  .muted{color:var(--muted)}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(12,18,32,0.06);border:1px solid var(--border);margin-bottom:14px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="number"], input[type="text"], select, input[type="date"], input[type="range"]{width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #e9f0fb;background:transparent;color:#0f172a}
  input[type="range"]{height:28px}
  .row{display:flex;gap:10px;align-items:center;margin-bottom:8px}
  .inline{display:inline-flex;gap:8px;align-items:center}
  button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  .exportBtn{background:#fff;border:1px solid #e6eef8;color:var(--muted);padding:8px;border-radius:8px;cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  .grid-2{display:grid;grid-template-columns:1fr 420px;gap:16px}
  @media (max-width:1000px){.grid-2{grid-template-columns:1fr}}
  .asset-headers{display:flex;gap:8px;font-size:12px;color:var(--muted);margin-bottom:6px}
  .asset-headers div{flex:1}
  canvas{background:transparent;border-radius:6px}
  .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .legend .item{display:flex;gap:6px;align-items:center;color:var(--muted)}
  .colorBox{width:12px;height:12px;border-radius:3px}
  .presetBtn{background:#fff;border:1px solid #e6eef8;padding:8px 10px;border-radius:8px;cursor:pointer}
  .presetBtn.active{outline:2px solid rgba(37,99,235,0.12);background:linear-gradient(180deg,#f8fbff,#ffffff)}
  .muted-pill{background:#f1f5f9;padding:6px 8px;border-radius:999px;font-size:13px;color:var(--muted)}
  .footnote{font-size:13px;color:var(--muted);margin-top:10px}
  .flex{display:flex;gap:8px}
  .half{width:49%}
  .rightCol{display:flex;flex-direction:column;gap:12px}
  .stat{padding:10px;border-radius:8px;background:#fff;border:1px solid #eaf2ff}
  .summary-apply{display:flex;gap:8px;align-items:center}
  .code{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#0f1724;color:#fff;padding:6px;border-radius:6px;font-size:12px}
</style>
</head>
<body>
  <div class="app">
    <h1>Retirement Simulator — Smart Advisor</h1>
    <div class="muted">Two-screen flow: set your data, then play in the playground. Link to SSA shown where appropriate.</div>

    <!-- ============================
         SCREEN 1 — INPUTS (SETUP)
         ============================ -->
    <section id="setupScreen" class="card" aria-label="Setup screen">
      <!-- Input Header -->
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-weight:600">1) Your data</div>
          <div class="small muted">Enter demographics, assets, tax assumptions and any known Social Security benefit.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="runAndGoBtn">Run simulation → Playground</button>
          <button id="saveScenario" class="exportBtn">Save (local)</button>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;height:1px;background:#eef6ff">

      <div class="grid-2">
        <!-- LEFT: main inputs -->
        <div>
          <!-- Demographics -->
          <div style="display:flex;gap:8px">
            <div style="flex:1">
              <label>Birthdate (month & year)</label>
              <input id="birthdate" type="month" value="">
            </div>
            <div style="width:180px">
              <label>Planned retirement age</label>
              <input id="plannedRetAge" type="number" min="30" max="80" value="60">
            </div>
            <div style="width:160px">
              <label>Life expectancy</label>
              <input id="lifeExpectancy" type="number" min="70" max="110" value="90">
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1">
              <label>Discount rate (annual %)</label>
              <input id="discountRate" type="number" value="3" step="0.1">
            </div>
            <div style="width:180px">
              <label>Default FRA (yrs)</label>
              <input id="userFRA" type="number" value="67" min="62" max="70">
            </div>
            <div style="width:180px">
              <label>Desired monthly income (after-tax)</label>
              <input id="desiredIncomeInput" type="number" value="5000">
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1">
              <label>Marginal ordinary tax rate (%)</label>
              <input id="userOrdTaxRate" type="number" value="22">
            </div>
            <div style="width:180px">
              <label>Assumed LTCG tax rate (%)</label>
              <input id="userLTCGRate" type="number" value="15">
            </div>
          </div>

          <hr style="margin:12px 0;border:none;height:1px;background:#eef6ff">

          <!-- Assets -->
          <label>Assets (enter each account)</label>
          <div class="asset-headers card" style="display:flex;padding:8px;margin-bottom:6px">
            <div style="flex:1">Label</div>
            <div style="width:90px">Value</div>
            <div style="width:90px">Growth %</div>
            <div style="width:90px">Avail Age</div>
            <div style="width:120px">Type</div>
            <div style="width:110px">Cost Basis</div>
            <div style="width:90px">Vol %</div>
            <div style="width:40px"></div>
          </div>
          <div id="assetList"></div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="addAssetBtn">+ Add asset</button>
            <button id="loadDemoBtn" class="exportBtn">Load demo</button>
            <button id="exportCSVsetup" class="exportBtn">Export CSV</button>
          </div>

          <div style="margin-top:12px">
            <label>Per-asset withdrawals (optional - overrides baseline)</label>
            <div id="assetWithdrawals"></div>
            <div class="footnote">Manual withdrawals will be taken first for each year; if left blank the simulator uses the strategy preset / custom mix.</div>
          </div>
        </div>

        <!-- RIGHT: other incomes, SS -->
        <div class="rightCol">
          <div class="card">
            <label>Other incomes</label>
            <div id="otherIncomeList"></div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="addOtherBtn" class="exportBtn">+ Add other income</button>
              <button id="clearOtherBtn" class="exportBtn">Clear</button>
            </div>
            <div class="footnote">Pensions, rental income, annuities, etc. Enter monthly amounts and optional end age.</div>
          </div>

          <div class="card">
            <label>Social Security (optional)</label>
            <div class="small muted">If you know your SSA monthly benefit, enter it. Otherwise the app uses the default average FRA benefit $1,963/month @ FRA 67.</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <div style="flex:1"><label>Known SSA monthly (optional)</label><input id="ssaMonthlyInput" type="number" placeholder="e.g. 1800"></div>
              <div style="width:120px"><label>Claim age (manual)</label><input id="ssaManualClaimAge" type="number" placeholder=""></div>
            </div>
            <div style="margin-top:8px;font-size:13px"><a href="https://www.ssa.gov/myaccount/" target="_blank">Lookup on SSA.gov</a></div>
          </div>

          <div class="card">
            <label>Quick controls</label>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="runSimBtn" class="exportBtn">Run simulation (stay)</button>
              <button id="optimizeBtn" class="exportBtn">Quick Optimize (fast)</button>
            </div>
            <div class="footnote">Optimization does a quick grid search (fast). Use the Playground to explore results and apply.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ============================
         SCREEN 2 — PLAYGROUND (RESULTS)
         ============================ -->
    <section id="resultsScreen" class="card" aria-label="Results and playground" style="display:block">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div style="font-weight:600">2) Playground</div>
          <div class="small muted">Play with SS timing, desired income, and withdrawal strategies. Compare your scenario with the optimizer's recommended plan.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="backToSetup" class="exportBtn">Back to setup</button>
          <button id="applyOptBtn" class="exportBtn" disabled>Apply Optimal Plan</button>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;height:1px;background:#eef6ff">

      <!-- Controls: SS slider, desired income slider, Monte Carlo -->
      <div style="display:flex;gap:12px;align-items:center">
        <div style="flex:1">
          <label>Social Security claim age (62–70)</label>
          <input id="claimAgeSlider" type="range" min="62" max="70" value="66" oninput="document.getElementById('claimAgeLabel').innerText=this.value; runSimulation()">
          <div class="inline"><strong id="claimAgeLabel">66</strong> yrs — <span id="ssaInfo" class="muted" style="margin-left:8px"></span></div>
        </div>

        <div style="width:260px">
          <label>Desired monthly income (after-tax)</label>
          <input id="desiredIncomeSlider" type="range" min="1000" max="20000" step="50" value="5000" oninput="document.getElementById('desiredIncomeLabel').innerText='$'+this.value; syncDesiredFromSlider()">
          <div class="muted-pill" style="margin-top:8px">Desired: <span id="desiredIncomeLabel">$5000</span></div>
        </div>

        <div style="width:220px">
          <label>Monte Carlo (off by default)</label>
          <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <input id="mcToggle" type="checkbox" onchange="runSimulation()">
            <div class="small muted">Enable</div>
          </div>
        </div>

        <div style="width:160px">
          <label>MC runs</label>
          <input id="mcRuns" type="number" min="50" max="2000" value="500" onchange="runSimulation()">
        </div>
      </div>

      <hr style="margin:12px 0;border:none;height:1px;background:#eef6ff">

      <!-- Withdrawal strategy presets -->
      <div style="display:flex;gap:12px;align-items:center">
        <div>
          <label>Withdrawal Strategy Presets</label>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="presetBtn" id="presetTaxEff">Tax-Efficient Order</button>
            <button class="presetBtn" id="presetEven">Even Mix</button>
            <button class="presetBtn" id="presetRothFirst">Roth-First</button>
            <button class="presetBtn" id="presetCustom">Custom</button>
          </div>
        </div>

        <div style="flex:1">
          <div id="presetSummary" class="muted" style="margin-top:6px">Preset summary will appear here.</div>
        </div>

        <div style="width:420px">
          <div id="customControls" style="display:none">
            <label>Custom mix (percentages will normalize to 100%)</label>
            <div style="display:flex;gap:8px">
              <div style="flex:1">
                <div class="small">Taxable %</div>
                <input id="customTaxable" type="range" min="0" max="100" value="30" oninput="normalizeCustomMix(); runSimulation()">
                <div class="muted-pill"> <span id="customTaxableLabel">30%</span> Taxable</div>
              </div>
              <div style="flex:1">
                <div class="small">Traditional %</div>
                <input id="customTraditional" type="range" min="0" max="100" value="50" oninput="normalizeCustomMix(); runSimulation()">
                <div class="muted-pill"> <span id="customTraditionalLabel">50%</span> Traditional</div>
              </div>
              <div style="flex:1">
                <div class="small">Roth %</div>
                <input id="customRoth" type="range" min="0" max="100" value="20" oninput="normalizeCustomMix(); runSimulation()">
                <div class="muted-pill"> <span id="customRothLabel">20%</span> Roth</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;height:1px;background:#eef6ff">

      <!-- Charts -->
      <div style="display:grid;grid-template-columns:1fr 360px;gap:12px">
        <div class="card">
          <label>Income Chart — desired vs actual</label>
          <canvas id="incomeChart" height="260"></canvas>
          <div class="small muted" style="margin-top:8px">Tooltips show breakdown of income sources for each age.</div>
        </div>

        <div style="display:flex;flex-direction:column;gap:12px">
          <div class="card">
            <label>Optimization summary</label>
            <div id="optSummaryArea" style="margin-top:8px">
              <div class="stat" id="optSummary">No optimization run yet.</div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button id="optimizePlayground" class="exportBtn">Optimize (fast grid)</button>
                <button id="optCompareBtn" class="exportBtn" disabled>Compare optimized vs custom</button>
              </div>
            </div>
          </div>

          <div class="card">
            <label>Tax summary</label>
            <div id="taxSummary">Total taxes (cum): <strong id="taxTotal">$0</strong></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <label>Cumulative Assets — per-account lines + total</label>
        <canvas id="cumulativeChart" height="320"></canvas>
        <div class="legend" id="cumulativeLegend"></div>
      </div>

    </section>

    <footer style="margin-top:12px" class="muted small">
      Notes: SSA default = $1,963/month @ FRA 67 if you leave SSA benefit blank. Optimization uses user discount rate to compute NPV of after-tax income. Monte Carlo off by default. Data is local to your browser. Ask me to export/save profiles or change optimization grid size.
    </footer>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
  /* =====================================================
     Retirement Simulator — single-file implementation
     Sections:
      - Utilities & defaults
      - DOM wiring / UI helpers
      - SSA and tax helper functions
      - Simulation engine (per-year per-asset balances)
      - Monte Carlo support
      - Fast optimizer (grid search by claim age and mix)
      - Charts and UI update functions
     ===================================================== */

  // ------------------------------
  // Utilities & defaults
  // ------------------------------
  function $(id){ return document.getElementById(id); }
  const DEFAULT_FRA_BENEFIT = 1963; // $/month at FRA 67 per spec (user can override)
  let assetCounter = 0;
  function genAssetId(){ return 'asset_' + (++assetCounter); }

  // chart handles
  let incomeChart = null;
  let cumulativeChart = null;

  // store latest simulation result
  let lastSim = null;
  let lastOptimized = null; // stores best optimization result

  // ------------------------------
  // DOM wiring & small helpers
  // ------------------------------
  // sync desired income input and slider
  $('desiredIncomeInput').addEventListener('input', (e) => {
    const v = Number(e.target.value) || 0;
    $('desiredIncomeSlider').value = v;
    $('desiredIncomeLabel').innerText = '$' + v;
    runSimulation();
  });
  function syncDesiredFromSlider(){
    const v = Number($('desiredIncomeSlider').value);
    $('desiredIncomeInput').value = v;
    $('desiredIncomeLabel').innerText = '$' + v;
    runSimulation();
  }

  // Add asset / withdrawals / other incomes UI functions
  function addAsset(label='', value=0, growth=5, availAge=62, type='Traditional 401(k)', costBasis=0, vol=10) {
    const id = genAssetId();
    const row = document.createElement('div');
    row.className = 'row';
    row.dataset.id = id;
    row.style.marginBottom='8px';
    row.innerHTML = `
      <input class="asset-label" type="text" value="${label}" style="flex:1">
      <input class="asset-value" type="number" value="${value}" style="width:90px">
      <input class="asset-growth" type="number" value="${growth}" style="width:90px">
      <input class="asset-age" type="number" value="${availAge}" style="width:90px">
      <select class="asset-type" style="width:120px">
        <option ${type==='Traditional 401(k)'?'selected':''}>Traditional 401(k)</option>
        <option ${type==='Traditional IRA'?'selected':''}>Traditional IRA</option>
        <option ${type==='Roth IRA'?'selected':''}>Roth IRA</option>
        <option ${type==='Roth 401(k)'?'selected':''}>Roth 401(k)</option>
        <option ${type==='Taxable brokerage'?'selected':''}>Taxable brokerage</option>
        <option ${type==='Real estate'?'selected':''}>Real estate</option>
        <option ${type==='Cash'?'selected':''}>Cash</option>
      </select>
      <input class="asset-basis" type="number" value="${costBasis}" style="width:110px">
      <input class="asset-vol" type="number" value="${vol}" style="width:90px">
      <button class="delAsset" style="width:40px">×</button>
    `;
    $('assetList').appendChild(row);

    // add withdrawal row linked
    addWithdrawalRow(id, label, availAge);

    row.querySelector('.delAsset').addEventListener('click', ()=> {
      // delete linked withdraw row too
      const w = document.querySelector(`#assetWithdrawals .row[data-id="${id}"]`);
      if (w) w.remove();
      row.remove(); runSimulation();
    });
    Array.from(row.querySelectorAll('input,select')).forEach(i => i.addEventListener('input', runSimulation));
  }

  function addWithdrawalRow(id, label, startAge){
    const wcont = $('assetWithdrawals');
    const row = document.createElement('div');
    row.className = 'row';
    row.dataset.id = id;
    row.style.marginBottom='6px';
    row.innerHTML = `
      <div style="flex:2" class="withdraw-label">${label}</div>
      <input class="withdrawStart" type="number" value="${startAge}" style="width:90px">
      <input class="withdrawMonthly" type="number" placeholder="Monthly" style="width:120px">
      <div class="small muted" style="width:120px;text-align:center">Tax est: <span class="tax-est">—</span></div>
    `;
    wcont.appendChild(row);
    Array.from(row.querySelectorAll('input')).forEach(i => i.addEventListener('input', runSimulation));
  }

  function addOtherIncome(label='Pension', monthly=0, endAge='') {
    const cont = $('otherIncomeList');
    const row = document.createElement('div');
    row.className = 'row';
    row.style.marginBottom='6px';
    row.innerHTML = `<input type="text" value="${label}" style="flex:1"><input type="number" value="${monthly}" style="width:120px"><input type="number" value="${endAge}" placeholder="end age" style="width:120px"><button class="del">×</button>`;
    cont.appendChild(row);
    row.querySelector('.del').addEventListener('click', ()=> { row.remove(); runSimulation(); });
    Array.from(row.querySelectorAll('input')).forEach(i => i.addEventListener('input', runSimulation));
  }

  // initial demo loader
  function loadDemo() {
    $('assetList').innerHTML=''; $('assetWithdrawals').innerHTML=''; $('otherIncomeList').innerHTML='';
    addAsset('401k', 600000, 5, 59, 'Traditional 401(k)', 0, 12);
    addAsset('Roth IRA', 150000, 5, 59, 'Roth IRA', 0, 8);
    addAsset('Brokerage', 200000, 6, 55, 'Taxable brokerage', 90000, 12);
    setTimeout(()=> {
      // set some withdrawal values
      Array.from($('assetWithdrawals').children).forEach(r=>{
        const lbl = r.querySelector('.withdraw-label').textContent.toLowerCase();
        if (lbl.includes('401k')) { r.querySelector('.withdrawMonthly').value = 2000; r.querySelector('.withdrawStart').value = 62; }
        if (lbl.includes('roth')) { r.querySelector('.withdrawMonthly').value = 500; r.querySelector('.withdrawStart').value = 62; }
        if (lbl.includes('brokerage')) { r.querySelector('.withdrawMonthly').value = 1000; r.querySelector('.withdrawStart').value = 60; }
      });
      addOtherIncome('Pension', 800, 85);
      $('ssaMonthlyInput').value = 2000;
      $('claimAgeSlider').value = 66; $('claimAgeLabel').innerText = '66';
      $('desiredIncomeInput').value = 5000; $('desiredIncomeSlider').value = 5000; $('desiredIncomeLabel').innerText = '$5000';
      runSimulation();
    }, 40);
  }

  // event wiring
  $('addAssetBtn').addEventListener('click', ()=> addAsset());
  $('loadDemoBtn').addEventListener('click', loadDemo);
  $('addOtherBtn').addEventListener('click', ()=> addOtherIncome());
  $('clearOtherBtn').addEventListener('click', ()=> { $('otherIncomeList').innerHTML=''; runSimulation(); });
  $('runAndGoBtn').addEventListener('click', ()=> { runSimulation(); document.getElementById('resultsScreen').scrollIntoView({behavior:'smooth'}); });
  $('runSimBtn').addEventListener('click', runSimulation);
  $('backToSetup').addEventListener('click', ()=> { document.getElementById('setupScreen').scrollIntoView({behavior:'smooth'}); });
  $('exportCSVsetup').addEventListener('click', ()=> exportCSV('setup'));
  $('exportCSVsetup').addEventListener('click', ()=> {});
  $('optimizeBtn').addEventListener('click', ()=> { fastOptimizeAndShow(); });
  $('optimizePlayground').addEventListener('click', ()=> { fastOptimizeAndShow(); });
  $('optCompareBtn').addEventListener('click', ()=> { showCompare(); });

  $('applyOptBtn').addEventListener('click', applyOptimizedPlan);

  // Preset handling
  const presets = {
    taxEff: { name: 'Tax-Efficient Order', strategy: 'taxEff' },
    even: { name: 'Even Mix', strategy: 'even' },
    rothFirst: { name: 'Roth-First', strategy: 'rothFirst' },
    custom: { name: 'Custom', strategy: 'custom' }
  };
  function setActivePreset(key) {
    ['presetTaxEff','presetEven','presetRothFirst','presetCustom'].forEach(id=> $(id).classList.remove('active'));
    if (key === 'taxEff') $( 'presetTaxEff').classList.add('active');
    if (key === 'even') $( 'presetEven').classList.add('active');
    if (key === 'rothFirst') $( 'presetRothFirst').classList.add('active');
    if (key === 'custom') $( 'presetCustom').classList.add('active');
    // toggle custom controls
    $('customControls').style.display = (key==='custom') ? 'block' : 'none';
    updatePresetSummary();
  }
  $('presetTaxEff').addEventListener('click', ()=> { setActivePreset('taxEff'); runSimulation(); });
  $('presetEven').addEventListener('click', ()=> { setActivePreset('even'); runSimulation(); });
  $('presetRothFirst').addEventListener('click', ()=> { setActivePreset('rothFirst'); runSimulation(); });
  $('presetCustom').addEventListener('click', ()=> { setActivePreset('custom'); runSimulation(); });

  function normalizeCustomMix(){
    let t = Number($('customTaxable').value), tr = Number($('customTraditional').value), r = Number($('customRoth').value);
    let sum = t+tr+r;
    if (sum === 0) { $('customTaxable').value = 34; $('customTraditional').value = 33; $('customRoth').value = 33; t=34;tr=33;r=33; sum=100;}
    const nt = Math.round(t/sum*100), ntr = Math.round(tr/sum*100);
    const nr = 100 - nt - ntr;
    $('customTaxable').value = nt; $('customTraditional').value = ntr; $('customRoth').value = nr;
    $('customTaxableLabel').innerText = nt + '%';
    $('customTraditionalLabel').innerText = ntr + '%';
    $('customRothLabel').innerText = nr + '%';
  }
  normalizeCustomMix();

  // ------------------------------
  // SSA helper functions
  // ------------------------------
  // Compute FRA from birthdate roughly (we keep user override via userFRA). For simplicity:
  // We'll default FRA to userFRA control; but if birthdate is provided, use userFRA as baseline (user can adjust).
  function getFRAFromBirthdate(){
    const birth = $('birthdate').value;
    if (!birth) return Number($('userFRA').value) || 67;
    // birth is YYYY-MM — compute year -> FRA based on US rules mostly 67 for those born 1960 or later
    const [yr,mo] = birth.split('-').map(Number);
    // US rules: born 1960+ => FRA 67; born 1955-59 -> 66 + x months; born earlier -> 66 or 65 per table.
    if (yr >= 1960) return 67;
    if (yr >= 1955) return 66 + (yr - 1955); // rough mapping (1955 -> 66+2 months etc) - allow user override
    return Number($('userFRA').value) || 67;
  }

  // SSA monthly adjuster using exact monthly rules provided:
  //  - early: reduction = monthsEarly * (5/9 of 1%) for first 36 months, then (5/12 of 1%) after that.
  //  - delayed: increase = monthsDelayed * (2/3 of 1%) per month.
  function adjustSSBenefitFromFRA(monthlyAtFRA, claimAge, FRA) {
    const monthsDiff = Math.round((claimAge - FRA) * 12);
    if (monthsDiff === 0) return monthlyAtFRA;
    if (monthsDiff < 0) {
      const monthsEarly = Math.abs(monthsDiff);
      let reductionPct = 0;
      const first36 = Math.min(36, monthsEarly);
      reductionPct += first36 * ((5/9) / 100.0);
      if (monthsEarly > 36) {
        const beyond = monthsEarly - 36;
        reductionPct += beyond * ((5/12) / 100.0);
      }
      return monthlyAtFRA * (1 - reductionPct);
    } else {
      const increasePct = monthsDiff * ((2/3) / 100.0);
      return monthlyAtFRA * (1 + increasePct);
    }
  }

  // ------------------------------
  // Tax helper functions
  // ------------------------------
  function getOrdRate(){ return (Number($('userOrdTaxRate').value) || 22) / 100; }
  function getLtcgRate(){ return (Number($('userLTCGRate').value) || 15) / 100; }

  // estimate tax on an annual withdrawal for a specific asset object
  function estimateTaxOnAnnualWithdrawal(assetObj, annualAmount){
    if (!assetObj) return { tax:0, afterTax: annualAmount };
    const type = assetObj.type;
    if (annualAmount <= 0) return { tax:0, afterTax: annualAmount };
    if (type.includes('Roth')) return { tax:0, afterTax: annualAmount };
    if (type.includes('Traditional')) {
      const tax = annualAmount * getOrdRate();
      return { tax, afterTax: annualAmount - tax };
    }
    // Taxable or Real estate
    if (type === 'Taxable brokerage' || type === 'Real estate' || type === 'Cash') {
      const total = assetObj.balance || assetObj.value || 0;
      const basis = Number(assetObj.basis) || 0;
      const basisPortion = total > 0 ? Math.max(0, Math.min(1, basis / total)) : 0;
      const basisTaken = annualAmount * basisPortion;
      const gainTaken = Math.max(0, annualAmount - basisTaken);
      const heldYears = Number(assetObj.heldYears) || 2;
      const isLong = heldYears >= 1;
      const rate = isLong ? getLtcgRate() : getOrdRate();
      const tax = gainTaken * rate;
      return { tax, afterTax: annualAmount - tax };
    }
    // fallback
    const tax = annualAmount * getOrdRate();
    return { tax, afterTax: annualAmount - tax };
  }

  // ------------------------------
  // Simulation engine
  // ------------------------------
  // simulateProjection: deterministic projection that returns year-by-year
  // balances per asset, income sources, taxes, and cumulative values.
  // Inputs:
  //  - options: { currentAge, lifeExp, desiredMonthly, claimAge, ssaMonthlyAtFRA, FRA, assets[], withdrawalMap, otherIncome[], mix: {taxable, traditional, roth}, mcOn(false) }
  function simulateProjection(options){
    const {
      currentAge, lifeExp, desiredMonthly, claimAge, ssaMonthlyAtFRA, FRA,
      assets: assetsInput, withdrawalMap, otherIncome, mix
    } = options;

    // clone runtime assets with balances and metadata
    const runtimeAssets = assetsInput.map(a => ({
      id: a.id, label: a.label, type: a.type, balance: a.value, growth: a.growth, basis: a.basis, vol: a.vol, heldYears: a.heldYears
    }));

    const yearly = [];
    let cumulativeTaxes = 0;

    // compute monthly SS at chosen claim age from the FRA baseline
    const monthlyAtFRA = ssaMonthlyAtFRA || DEFAULT_FRA_BENEFIT;
    const ssaAtChosen = adjustSSBenefitFromFRA(monthlyAtFRA, claimAge, FRA);

    for (let age = currentAge; age <= lifeExp; age++){
      // apply growth to balances (deterministic)
      runtimeAssets.forEach(a => {
        a.balance *= (1 + (a.growth || 0) / 100.0);
      });

      // income sources
      const ssMonthly = (age >= claimAge) ? ssaAtChosen : 0;
      const otherMonthly = otherIncome.reduce((s,o) => s + ((age <= o.endAge) ? o.monthly : 0), 0);
      const guaranteedMonthly = ssMonthly + otherMonthly;
      const requiredMonthly = Math.max(0, desiredMonthly - guaranteedMonthly);

      // manual withdrawals first (per-asset)
      let manualProvidedMonthly = 0;
      const manualDetail = [];
      Object.keys(withdrawalMap).forEach(assetId => {
        const w = withdrawalMap[assetId];
        if (!w) return;
        if (age >= (w.startAge || 0) && w.monthly > 0) {
          const assetObj = runtimeAssets.find(x => x.id === assetId);
          if (!assetObj) return;
          const annual = Math.min(assetObj.balance, w.monthly * 12);
          assetObj.balance -= annual;
          const taxInfo = estimateTaxOnAnnualWithdrawal(assetObj, annual);
          cumulativeTaxes += taxInfo.tax;
          manualProvidedMonthly += annual / 12;
          manualDetail.push({ assetId, label: assetObj.label, monthly: Math.round(annual/12), taxMonthly: taxInfo.tax/12 });
        }
      });

      // remaining needed monthly after manual
      let remainingNeededMonthly = Math.max(0, requiredMonthly - manualProvidedMonthly);

      // auto withdrawal based on mix
      const autoDetail = [];
      if (remainingNeededMonthly > 0) {
        // compute bucket totals
        const buckets = {
          taxable: runtimeAssets.filter(a => a.type === 'Taxable brokerage' || a.type === 'Real estate' || a.type === 'Cash'),
          traditional: runtimeAssets.filter(a => a.type.includes('Traditional')),
          roth: runtimeAssets.filter(a => a.type.includes('Roth'))
        };
        // helper to withdraw proportionally from a bucket
        function withdrawBucket(bucketArr, targetMonthly) {
          if (!bucketArr || bucketArr.length === 0) return { monthly: 0, tax: 0, items: [] };
          const annualTarget = targetMonthly * 12;
          const totalBal = bucketArr.reduce((s,x)=>s + x.balance, 0);
          if (totalBal <= 0) return { monthly: 0, tax: 0, items: [] };
          let monthlyTaken = 0;
          let taxTaken = 0;
          const items = [];
          bucketArr.forEach(a => {
            const portion = a.balance / totalBal;
            const takeAnnual = Math.min(a.balance, annualTarget * portion);
            a.balance -= takeAnnual;
            const taxInfo = estimateTaxOnAnnualWithdrawal(a, takeAnnual);
            monthlyTaken += takeAnnual / 12;
            taxTaken += taxInfo.tax;
            items.push({ id: a.id, label: a.label, monthly: takeAnnual/12, taxMonthly: taxInfo.tax/12 });
          });
          cumulativeTaxes += taxTaken;
          return { monthly: monthlyTaken, tax: taxTaken, items };
        }
        // apply mix fractions
        const tTax = withdrawBucket(buckets.taxable, remainingNeededMonthly * (mix.taxable || 0));
        const tTrad = withdrawBucket(buckets.traditional, remainingNeededMonthly * (mix.traditional || 0));
        const tRoth = withdrawBucket(buckets.roth, remainingNeededMonthly * (mix.roth || 0));
        autoDetail.push({ taxable: tTax, traditional: tTrad, roth: tRoth });
      }

      // sum provided monthly (ss + other + manual + auto)
      const autoMonthlySum = autoDetail.length ? ( (autoDetail[0].taxable.monthly||0) + (autoDetail[0].traditional.monthly||0) + (autoDetail[0].roth.monthly||0) ) : 0;
      const providedMonthly = ssMonthly + otherMonthly + manualProvidedMonthly + autoMonthlySum;

      // track balances snapshot
      const balances = {};
      runtimeAssets.forEach(a => balances[a.label] = Math.round(a.balance));

      yearly.push({
        age,
        ssMonthly: Math.round(ssMonthly),
        otherMonthly: Math.round(otherMonthly),
        manualProvidedMonthly: Math.round(manualProvidedMonthly),
        autoProvidedMonthly: Math.round(autoMonthlySum),
        providedMonthly: Math.round(providedMonthly),
        desiredMonthly,
        balances,
        taxesCum: Math.round(cumulativeTaxes)
      });
    }

    return {
      yearlyData: yearly,
      totalTaxes: Math.round(cumulativeTaxes)
    };
  }

  // ------------------------------
  // Monte Carlo support (fast)
  // ------------------------------
  // Runs N simulations using random annual returns (normal approx) using mean = growth% and sigma = vol (fraction).
  function runMonteCarlo(options, runs=500) {
    // We'll only compute total portfolio across years for median and survival metric to keep mc fast.
    const { currentAge, lifeExp, desiredMonthly, claimAge, ssaMonthlyAtFRA, FRA, assets: assetsInput, withdrawalMap, otherIncome, mix } = options;
    const years = lifeExp - currentAge + 1;
    const allTotals = [];
    for (let r=0; r<runs; r++){
      // clone assets
      const runtime = assetsInput.map(a => ({ id: a.id, label: a.label, type: a.type, balance: a.value, growth: a.growth, vol: a.vol, basis: a.basis }));
      const totals = [];
      for (let age = currentAge; age <= lifeExp; age++){
        // apply random growth
        runtime.forEach(a => {
          const mu = a.growth / 100;
          const sigma = (a.vol || 10) / 100;
          const ret = sampleNormal(mu, sigma);
          a.balance *= (1 + ret);
        });

        // simple withdrawal approach: manual then mix (same as deterministic)
        // manual
        let manualProvidedMonthly = 0;
        Object.keys(withdrawalMap).forEach(aid => {
          const w = withdrawalMap[aid];
          if (!w) return;
          if (age >= (w.startAge || 0) && w.monthly > 0) {
            const assetObj = runtime.find(x => x.id === aid);
            if (!assetObj) return;
            const annual = Math.min(assetObj.balance, w.monthly * 12);
            assetObj.balance -= annual;
            manualProvidedMonthly += annual/12;
          }
        });

        const ssMonthly = (age >= claimAge) ? adjustSSBenefitFromFRA(ssaMonthlyAtFRA||DEFAULT_FRA_BENEFIT, claimAge, FRA) : 0;
        const otherMonthly = otherIncome.reduce((s,o)=>s + ((age <= o.endAge) ? o.monthly : 0), 0);
        const guaranteedMonthly = ssMonthly + otherMonthly;
        const requiredMonthly = Math.max(0, desiredMonthly - guaranteedMonthly);
        let remainingNeededMonthly = Math.max(0, requiredMonthly - manualProvidedMonthly);

        // withdraw by mix
        const buckets = {
          taxable: runtime.filter(a => a.type === 'Taxable brokerage' || a.type === 'Real estate' || a.type === 'Cash'),
          traditional: runtime.filter(a => a.type.includes('Traditional')),
          roth: runtime.filter(a => a.type.includes('Roth'))
        };
        function withdrawBucket(bucketArr, targetMonthly) {
          if (!bucketArr || bucketArr.length === 0) return 0;
          const annualTarget = targetMonthly * 12;
          const totalBal = bucketArr.reduce((s,x)=>s + x.balance, 0);
          if (totalBal <= 0) return 0;
          let monthlyTaken = 0;
          bucketArr.forEach(a => {
            const portion = a.balance / totalBal;
            const takeAnnual = Math.min(a.balance, annualTarget * portion);
            a.balance -= takeAnnual;
            monthlyTaken += takeAnnual / 12;
          });
          return monthlyTaken;
        }
        const autoSum = withdrawBucket(buckets.taxable, remainingNeededMonthly * (mix.taxable||0)) + withdrawBucket(buckets.traditional, remainingNeededMonthly * (mix.traditional||0)) + withdrawBucket(buckets.roth, remainingNeededMonthly * (mix.roth||0));
        const totalPortfolio = Math.round(runtime.reduce((s,x)=>s + x.balance,0));
        totals.push(totalPortfolio);
      }
      allTotals.push(totals);
    }

    // compute median trajectory
    const yearsLen = allTotals[0].length;
    const medianTrajectory = [];
    for (let i=0;i<yearsLen;i++){
      const vals = allTotals.map(a=>a[i]).sort((a,b)=>a-b);
      medianTrajectory.push(vals[Math.floor(vals.length/2)]);
    }
    // survival prob = fraction where last year > 0
    const survivors = allTotals.filter(a => a[a.length-1] > 0).length;
    const survivalProb = (survivors / allTotals.length) * 100;
    return { medianTrajectory, survivalProb };
  }

  function sampleNormal(mu, sigma){
    // Box-Muller
    let u = 0, v = 0;
    while(u === 0) u = Math.random();
    while(v === 0) v = Math.random();
    const std = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    return mu + std * sigma;
  }

  // ------------------------------
  // Fast optimizer (grid search)
  // ------------------------------
  // Goal: maximize after-tax lifetime NPV using discount rate
  // We'll search claimAge 62-70 step 1 year, and mixes in 10% steps (taxable/trad; roth = remainder)
  // This is intentionally coarse for speed. Returns best scenario and topN candidates.
  async function fastOptimize(options) {
    const { currentAge, lifeExp, desiredMonthly, ssaMonthlyAtFRA, FRA, assets, withdrawalMap, otherIncome } = options;
    const discountRate = Number($('discountRate').value)/100 || 0.03;

    const claimAges = [];
    for (let a=62; a<=70; a++) claimAges.push(a);
    const mixes = [];
    for (let t=0; t<=100; t+=10){
      for (let tr=0; tr<=100-t; tr+=10){
        const r = 100 - t - tr;
        mixes.push({ taxable: t/100, traditional: tr/100, roth: r/100 });
      }
    }

    let best = null;
    const results = [];
    // loop
    for (let ca of claimAges) {
      for (let m of mixes) {
        // simulate deterministic projection quickly
        const sim = simulateProjection({
          currentAge,
          lifeExp,
          desiredMonthly,
          claimAge: ca,
          ssaMonthlyAtFRA,
          FRA,
          assets,
          withdrawalMap,
          otherIncome,
          mix: m
        });
        // compute NPV: sum of after-tax annual income discounted to currentAge
        // Need to reconstruct after-tax annual income per year: providedMonthly and taxes tracked cumulatively are available.
        // We approximate after-tax annual income = providedMonthly*12  (taxes already applied via withdrawal estimates).
        const yearly = sim.yearlyData;
        let npv = 0;
        for (let i=0;i<yearly.length;i++){
          const y = yearly[i];
          const t = i; // years from currentAge
          const cf = y.providedMonthly * 12;
          npv += cf / Math.pow(1 + discountRate, t);
        }
        // record
        results.push({ claimAge: ca, mix: m, npv, totalTaxes: sim.totalTaxes });
        if (!best || npv > best.npv) best = { claimAge: ca, mix: m, npv, totalTaxes: sim.totalTaxes, sim };
      }
    }

    // sort top 5
    results.sort((a,b)=>b.npv - a.npv);
    return { best, top: results.slice(0,10) };
  }

  // Wrapper that reads UI & runs fastOptimize then updates UI
  async function fastOptimizeAndShow(){
    // read UI
    const currentAge = Number($('plannedRetAge').value) || 60;
    const lifeExp = Number($('lifeExpectancy').value) || 90;
    const desiredMonthly = Number($('desiredIncomeInput').value) || 5000;
    const FRA = getFRAFromBirthdate(); // uses birthdate or userFRA
    const ssaMonthlyAtFRA = Number($('ssaMonthlyInput').value) || DEFAULT_FRA_BENEFIT;

    // build assets
    const assets = Array.from($('assetList').children).map(div => ({
      id: div.dataset.id,
      label: div.querySelector('.asset-label').value,
      value: Number(div.querySelector('.asset-value').value) || 0,
      growth: Number(div.querySelector('.asset-growth').value) || 4,
      type: div.querySelector('.asset-type').value,
      basis: Number(div.querySelector('.asset-basis').value) || 0,
      vol: Number(div.querySelector('.asset-vol').value) || 10
    }));
    // withdrawal map
    const withdrawalMap = {};
    Array.from($('assetWithdrawals').children).forEach(row => {
      const id = row.dataset.id;
      withdrawalMap[id] = { startAge: Number(row.querySelector('.withdrawStart')?.value) || 62, monthly: Number(row.querySelector('.withdrawMonthly')?.value) || 0 };
    });
    // other income
    const otherIncome = Array.from($('otherIncomeList').children).map(r=>{
      const ins = r.querySelectorAll('input'); return { label: ins[0].value||'Other', monthly: Number(ins[1].value)||0, endAge: Number(ins[2].value) || lifeExp };
    });

    // run grid search
    $('optSummary').innerText = 'Running quick optimization (coarse grid)...';
    const opts = { currentAge: Number($('plannedRetAge').value), lifeExp, desiredMonthly, ssaMonthlyAtFRA, FRA, assets, withdrawalMap, otherIncome };
    const res = await fastOptimize(opts);

    lastOptimized = res.best;
    // present summary
    const best = res.best;
    const mix = best.mix;
    const npv = Math.round(best.npv);
    const taxes = Math.round(best.totalTaxes || 0);
    const summaryHtml = `<div><strong>Optimized plan</strong><div class="muted" style="margin-top:6px">Claim SS age: <strong>${best.claimAge}</strong></div>
      <div class="muted">Withdrawal mix: Taxable ${Math.round(mix.taxable*100)}% / Traditional ${Math.round(mix.traditional*100)}% / Roth ${Math.round(mix.roth*100)}%</div>
      <div style="margin-top:6px">Lifetime after-tax NPV: <strong>$${npv.toLocaleString()}</strong></div>
      <div class="muted">Estimated total taxes (approx): <strong>$${taxes.toLocaleString()}</strong></div></div>`;
    $('optSummary').innerHTML = summaryHtml;
    $('applyOptBtn').disabled = false;
    $('optCompareBtn').disabled = false;
    // keep optimized result to show overlay when plotting
    // additionally, run a quick Monte Carlo check (small) for survival probability using optimized plan
    const mcOn = $('mcToggle').checked;
    if (!mcOn) {
      // quick MC for survival (100 runs)
      const mc = runMonteCarlo({ currentAge: Number($('plannedRetAge').value), lifeExp, desiredMonthly, claimAge: best.claimAge, ssaMonthlyAtFRA, FRA, assets, withdrawalMap, otherIncome, mix: best.mix }, 100);
      $('optSummary').innerHTML += `<div class="muted" style="margin-top:6px">Estimated survival to life expectancy (quick MC): <strong>${Math.round(mc.survivalProb)}%</strong></div>`;
    }
    // update charts to overlay optimized plan
    runSimulation(true); // pass flag to include overlay
  }

  // Apply optimized plan to playground controls (sets claim age and preset/custom mix)
  function applyOptimizedPlan(){
    if (!lastOptimized) return;
    $('claimAgeSlider').value = lastOptimized.claimAge;
    $('claimAgeLabel').innerText = lastOptimized.claimAge;
    // Set custom mix and turn on custom preset
    setActivePreset('custom');
    const m = lastOptimized.mix;
    $('customTaxable').value = Math.round(m.taxable*100);
    $('customTraditional').value = Math.round(m.traditional*100);
    $('customRoth').value = Math.round(m.roth*100);
    normalizeCustomMix();
    runSimulation();
  }

  // Comparison view: overlay optimized vs current for quick visual comparison
  function showCompare(){
    if (!lastOptimized) return;
    runSimulation(true); // with overlay
  }

  // ------------------------------
  // Simulation runner + UI update
  // ------------------------------
  // runSimulation(overlayOptimized=false) executes deterministic sim based on current UI state.
  function runSimulation(overlayOptimized=false){
    // read inputs
    const birth = $('birthdate').value;
    const currentAge = Number($('plannedRetAge').value) || 60;
    const lifeExp = Number($('lifeExpectancy').value) || 90;
    const desiredMonthly = Number($('desiredIncomeInput').value) || Number($('desiredIncomeSlider').value) || 5000;
    const FRA = getFRAFromBirthdate();
    const claimAge = Number($('claimAgeSlider').value) || 66;
    const ssaMonthlyAtFRA = Number($('ssaMonthlyInput').value) || DEFAULT_FRA_BENEFIT;

    $('ssaInfo').innerText = `SSA at chosen age: ~$${Math.round(adjustSSBenefitFromFRA(ssaMonthlyAtFRA, claimAge, FRA))}/mo`;

    // assets
    const assets = Array.from($('assetList').children).map(div => ({
      id: div.dataset.id,
      label: div.querySelector('.asset-label').value || 'Asset',
      value: Number(div.querySelector('.asset-value').value) || 0,
      growth: Number(div.querySelector('.asset-growth').value) || 4,
      type: div.querySelector('.asset-type').value,
      basis: Number(div.querySelector('.asset-basis').value) || 0,
      vol: Number(div.querySelector('.asset-vol').value) || 10
    }));

    // withdrawalMap
    const withdrawalMap = {};
    Array.from($('assetWithdrawals').children).forEach(row => {
      const id = row.dataset.id;
      const startAge = Number(row.querySelector('.withdrawStart')?.value) || 62;
      const monthly = Number(row.querySelector('.withdrawMonthly')?.value) || 0;
      withdrawalMap[id] = { startAge, monthly, taxElem: row.querySelector('.tax-est') };
    });

    // other incomes
    const otherIncome = Array.from($('otherIncomeList').children).map(r=>{
      const ins = r.querySelectorAll('input');
      return { label: ins[0].value || 'Other', monthly: Number(ins[1].value) || 0, endAge: Number(ins[2].value) || lifeExp };
    });

    // determine mix based on preset
    let mix = { taxable: 0.34, traditional: 0.33, roth: 0.33 };
    if ($('presetTaxEff').classList.contains('active')) {
      mix = { taxable: 0.4, traditional: 0.5, roth: 0.1 };
    } else if ($('presetEven').classList.contains('active')) {
      mix = { taxable: 0.33, traditional: 0.33, roth: 0.34 };
    } else if ($('presetRothFirst').classList.contains('active')) {
      mix = { taxable: 0.2, traditional: 0.3, roth: 0.5 };
    } else if ($('presetCustom').classList.contains('active')) {
      mix = { taxable: Number($('customTaxable').value)/100, traditional: Number($('customTraditional').value)/100, roth: Number($('customRoth').value)/100 };
    }

    // Call deterministic simulation
    const sim = simulateProjection({
      currentAge, lifeExp, desiredMonthly, claimAge, ssaMonthlyAtFRA, FRA, assets, withdrawalMap, otherIncome, mix
    });
    lastSim = { sim, options: { currentAge, lifeExp, desiredMonthly, claimAge, ssaMonthlyAtFRA, FRA, assets, withdrawalMap, otherIncome, mix } };

    // If MC enabled and requested, run MC for median and survival
    if ($('mcToggle').checked) {
      const mc = runMonteCarlo({ currentAge, lifeExp, desiredMonthly, claimAge, ssaMonthlyAtFRA, FRA, assets, withdrawalMap, otherIncome, mix }, Number($('mcRuns').value) || 500);
      lastSim.mc = mc;
    } else {
      lastSim.mc = null;
    }

    // update charts and UI (overlayOptimized may overlay lastOptimized)
    updateChartsAndUI(lastSim, overlayOptimized ? lastOptimized : null);
  }

  // ------------------------------
  // Charts & UI update
  // ------------------------------
  function updateChartsAndUI(simResult, overlayOptimized){
    if (!simResult) return;
    const sim = simResult.sim;
    const yearly = sim.yearlyData;
    // build labels (ages)
    const labels = yearly.map(y => y.age);

    // Income chart: show desired vs actual; tooltip show breakdown
    const desired = yearly.map(y => y.desiredMonthly);
    const actual = yearly.map(y => y.providedMonthly);

    // destroy old
    if (incomeChart) incomeChart.destroy();

    const ctx1 = $('incomeChart').getContext('2d');
    incomeChart = new Chart(ctx1, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Actual projected income', data: actual, borderColor: '#10b981', fill:false, tension:0.2, borderWidth:2 },
          { label: 'Desired income', data: desired, borderColor: '#ea580c', fill:false, tension:0.2, borderWidth:2, borderDash:[6,4] }
        ]
      },
      options: {
        responsive:true, animation:false, interaction:{mode:'index',intersect:false},
        plugins: {
          tooltip: {
            callbacks: {
              title: (items) => `Age: ${items[0].label}`,
              label: (context) => {
                const row = yearly[context.dataIndex];
                const lines = [];
                lines.push(`Desired Income: $${row.desiredMonthly}`);
                lines.push(`Actual Income: $${row.providedMonthly}`);
                lines.push(`Income Gap: $${row.desiredMonthly - row.providedMonthly}`);
                lines.push(`SS Income: $${row.ssMonthly}`);
                // show manual and auto contributions briefly
                lines.push(`Manual withdrawals: $${row.manualProvidedMonthly}`);
                lines.push(`Auto withdrawals: $${row.autoProvidedMonthly}`);
                return lines;
              }
            }
          }
        },
        scales: { x: { title: { display:true, text:'Age' } }, y: { title: { display:true, text:'Monthly ($)' } } }
      }
    });

    // Cumulative assets chart — per-asset lines + total portfolio
    // To plot per-asset we need to reconstruct asset balances series from sim: sim.yearlyData contains balances per label
    const assetLabels = Object.keys(yearly[0].balances);
    const datasets = [];
    const palette = ['#2563eb','#f97316','#7c3aed','#10b981','#06b6d4','#ef4444','#f59e0b'];
    assetLabels.forEach((al, idx) => {
      const data = yearly.map(y => y.balances[al] || 0);
      datasets.push({ label: al, data, borderColor: palette[idx%palette.length], borderWidth:2, fill:false, tension:0.2 });
    });
    // total portfolio line
    const total = yearly.map(y => assetLabels.reduce((s,al)=>s + (y.balances[al]||0),0));
    datasets.push({ label: 'Total portfolio', data: total, borderColor:'#0f172a', borderWidth:3, fill:false, tension:0.2 });

    // overlay optimized median (if MC present on optimized)
    if (overlayOptimized && lastOptimized && lastOptimized.sim) {
      const optSim = lastOptimized.sim;
      const optYearly = optSim.yearlyData;
      const optTotal = optYearly.map(y => Object.values(y.balances).reduce((s,v)=>s + v,0));
      datasets.push({ label: 'Optimized (total)', data: optTotal, borderColor:'#64748b', borderWidth:2, borderDash:[6,4], fill:false, tension:0.2 });
    } else if (overlayOptimized && lastOptimized && lastOptimized.mcMedian) {
      // optional
    }

    if (cumulativeChart) cumulativeChart.destroy();
    const ctx2 = $('cumulativeChart').getContext('2d');
    cumulativeChart = new Chart(ctx2, {
      type:'line',
      data: { labels, datasets },
      options: { responsive:true, animation:false, interaction:{mode:'index',intersect:false}, scales: { x:{title:{display:true,text:'Age'}}, y:{title:{display:true,text:'Value ($)'}}} }
    });

    // update legend
    const legend = $('cumulativeLegend'); legend.innerHTML='';
    datasets.slice(0,7).forEach(ds => {
      const el = document.createElement('div'); el.className='item';
      el.innerHTML = `<div class="colorBox" style="background:${ds.borderColor}"></div><div class="muted">${ds.label}</div>`;
      legend.appendChild(el);
    });

    // tax summary & other metrics
    $('taxTotal').innerText = `$${(sim.totalTaxes||0).toLocaleString()}`;

    // optimization overlay: if lastOptimized exists, compute small MC or show quick stats
    if (lastOptimized) {
      // show optimized quick numbers in optSummary (already set) and enable apply button
      $('applyOptBtn').disabled = false;
    } else {
      $('applyOptBtn').disabled = true;
    }
  }

  // ------------------------------
  // Helpers: export CSV & small utils
  // ------------------------------
  function exportCSV(context){
    // use lastSim if available
    if (!lastSim || !lastSim.sim) { alert('Run a simulation first'); return; }
    const arr = lastSim.sim.yearlyData;
    const hdr = ['age','ssMonthly','otherMonthly','manualMonthly','autoMonthly','providedMonthly','totalPortfolio','taxesCum'];
    const rows = [hdr.join(',')];
    arr.forEach(r => {
      const total = Object.values(r.balances).reduce((s,v)=>s+v,0);
      rows.push([r.age,r.ssMonthly,r.otherMonthly,r.manualProvidedMonthly,r.autoProvidedMonthly,r.providedMonthly,total,r.taxesCum].join(','));
    });
    const csv = rows.join('\n');
    const blob = new Blob([csv], { type:'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'retirement_projection.csv'; a.click(); URL.revokeObjectURL(url);
  }

  // ------------------------------
  // Small UI initializations & demo
  // ------------------------------
  // set initial preset
  setActivePreset('taxEff');
  // wire other buttons
  $('addAssetBtn').addEventListener('click', ()=> addAsset());
  $('addOtherBtn').addEventListener('click', ()=> addOtherIncome());
  $('loadDemoBtn').addEventListener('click', loadDemo);
  $('optCompareBtn').addEventListener('click', showCompare);
  $('ssaMonthlyInput').addEventListener('input', runSimulation);
  $('claimAgeSlider').addEventListener('input', runSimulation);
  $('customTaxable').addEventListener('input', ()=> { normalizeCustomMix(); runSimulation(); });
  $('customTraditional').addEventListener('input', ()=> { normalizeCustomMix(); runSimulation(); });
  $('customRoth').addEventListener('input', ()=> { normalizeCustomMix(); runSimulation(); });

  // initial demo load
  loadDemo();
  </script>
</body>
</html>
